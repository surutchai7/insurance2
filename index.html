<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>สำนักงานนายหน้าลูกนก ชุ่มชื่น</title>
  
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tracking Functions -->
  <script src="tracking.js" defer></script>
  
  <style>
    /* CSS Variables for Theming */
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #3498db;
      
      --bg-color: #f5f5f5;
      --bg-secondary: #ffffff;
      --text-color: #333333;
      --text-secondary: #7f8c8d;
      --border-color: #e0e0e0;
      
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
      
      --transition: all 0.3s ease;
    }
    
    /* Dark Theme */
    body.dark-theme {
      --bg-color: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --text-color: #ffffff;
      --text-secondary: #b0b0b0;
      --border-color: #404040;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
    }
    
    /* Dark theme scrollbar */
    body.dark-theme .workorder-left::-webkit-scrollbar-track,
    body.dark-theme .workorder-right::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    
    body.dark-theme .workorder-left::-webkit-scrollbar-thumb,
    body.dark-theme .workorder-right::-webkit-scrollbar-thumb {
      background: #555;
    }
    
    body.dark-theme .workorder-left::-webkit-scrollbar-thumb:hover,
    body.dark-theme .workorder-right::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
    
    body.dark-theme .items-table-compact input:disabled,
    body.dark-theme .items-table-compact select:disabled {
      background-color: #404040;
      color: #999;
    }
    
    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Sarabun', sans-serif;
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      transition: var(--transition);
      overflow-x: hidden;
    }
    
    /* Layout */
    .container {
      width: 100%;
      max-width: 100vw;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header */
    .header {
      background-color: var(--secondary-color);
      color: white;
      padding: 15px 0;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }
    
    .header h1 {
      font-size: 24px;
      margin: 0;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .theme-toggle:hover {
      background-color: rgba(255,255,255,0.1);
    }
    
    /* Navigation */
    .nav {
      background-color: var(--bg-secondary);
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      transition: var(--transition);
    }
    
    .nav-btn {
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }
    
    .nav-btn:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .nav-btn.active {
      background-color: var(--secondary-color);
    }
    
    /* Page Content */
    .page {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .page.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0;
        transform: translateY(10px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Cards */
    .card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .card-header h2 {
      color: var(--text-color);
      font-size: 20px;
      margin: 0;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .stat-card h3 {
      font-size: 32px;
      margin: 10px 0;
      color: var(--text-color);
    }
    
    .stat-card p {
      color: var(--text-secondary);
    }
    
    .stat-card.blue::before { background: linear-gradient(90deg, #3498db, #2980b9); }
    .stat-card.green::before { background: linear-gradient(90deg, #2ecc71, #27ae60); }
    .stat-card.orange::before { background: linear-gradient(90deg, #f39c12, #e67e22); }
    .stat-card.red::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }
    
    /* Forms - Enhanced for widescreen modals */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .modal .form-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    
    @media (max-width: 1200px) {
      .modal .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .modal .form-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .modal .form-group {
      margin-bottom: 10px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-color);
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 15px;
      font-family: 'Sarabun', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: var(--transition);
    }
    
    .modal textarea.form-control {
      min-height: 60px;
      max-height: 100px;
      resize: vertical;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Sarabun', sans-serif;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: #2980b9;
    }
    
    .btn-success {
      background-color: var(--success-color);
      color: white;
    }
    
    .btn-success:hover:not(:disabled) {
      background-color: #27ae60;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
      color: white;
    }
    
    .btn-warning:hover:not(:disabled) {
      background-color: #e67e22;
    }
    
    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }
    
    .btn-danger:hover:not(:disabled) {
      background-color: #c0392b;
    }
    
    .btn-info {
      background-color: var(--info-color);
      color: white;
    }
    
    .btn-info:hover:not(:disabled) {
      background-color: #2980b9;
    }
    
    .btn-secondary {
      background-color: var(--text-secondary);
      color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: #6c757d;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-sm {
      padding: 5px 10px;
      font-size: 14px;
    }
    
    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--bg-secondary);
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    th {
      background-color: var(--secondary-color);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr {
      transition: var(--transition);
    }
    
    tr:hover {
      background-color: var(--bg-color);
    }
    
    .table-actions {
      display: flex;
      gap: 5px;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
      overflow: hidden;
    }
    
    .modal-content {
      background-color: var(--bg-secondary);
      margin: 20px auto;
      padding: 0;
      border-radius: 8px;
      max-width: 95vw;
      width: 95%;
      max-height: calc(100vh - 40px);
      height: auto;
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      padding: 20px;
      background-color: var(--secondary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px 8px 0 0;
    }
    
    .modal-header h3 {
      margin: 0;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: white;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .close-btn:hover {
      background-color: rgba(255,255,255,0.1);
    }
    
    .modal-body {
      padding: 20px 30px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .modal-body form {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .modal-footer {
      padding: 15px 30px;
      background-color: var(--bg-color);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-radius: 0 0 8px 8px;
    }
    
    /* Loading */
    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-secondary);
      padding: 30px 50px;
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      z-index: 2000;
      text-align: center;
      min-width: 250px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      background-color: var(--success-color);
      color: white;
      border-radius: 4px;
      box-shadow: var(--shadow-lg);
      display: none;
      z-index: 3000;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
      word-wrap: break-word;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }
    
    .toast.error { background-color: var(--danger-color); }
    .toast.warning { background-color: var(--warning-color); }
    .toast.info { background-color: var(--info-color); }
    
    /* Sub Menu */
    .sub-menu {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 10px;
      background-color: var(--bg-color);
      border-radius: 4px;
      overflow-x: auto;
    }
    
    .sub-menu-btn {
      padding: 8px 16px;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      color: var(--text-color);
    }
    
    .sub-menu-btn:hover {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .sub-menu-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    /* Autocomplete Styles */
    .autocomplete-wrapper {
      position: relative;
    }
    
    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-shadow: var(--shadow-md);
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    
    .autocomplete-dropdown.show {
      display: block;
    }
    
    .autocomplete-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--border-color);
    }
    
    .autocomplete-item:hover {
      background-color: var(--bg-color);
    }
    
    .autocomplete-item.selected {
      background-color: var(--primary-color);
      color: white;
    }
    
    /* Work Order Page Layout - Updated for 2/3 and 1/3 split */
    .workorder-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      height: calc(100vh - 200px);
      max-width: 100%;
      margin: 0 auto;
    }
    
    .workorder-left {
      overflow-y: auto;
      padding-right: 10px;
      max-height: calc(100vh - 200px);
    }
    
    .workorder-right {
      overflow-y: auto;
      padding-left: 10px;
      max-height: calc(100vh - 200px);
    }
    
    /* Scrollbar styling */
    .workorder-left::-webkit-scrollbar,
    .workorder-right::-webkit-scrollbar {
      width: 8px;
    }
    
    .workorder-left::-webkit-scrollbar-track,
    .workorder-right::-webkit-scrollbar-track {
      background: var(--bg-color);
      border-radius: 4px;
    }
    
    .workorder-left::-webkit-scrollbar-thumb,
    .workorder-right::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    .workorder-left::-webkit-scrollbar-thumb:hover,
    .workorder-right::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
    
    /* Compact Work Order Items Table */
    .workorder-items-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .items-table-compact {
      width: 100%;
      font-size: 14px;
    }
    
    .items-table-compact th {
      background-color: var(--secondary-color);
      color: white;
      padding: 8px;
      text-align: left;
      font-size: 13px;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    .items-table-compact td {
      padding: 6px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .items-table-compact input,
    .items-table-compact select {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      font-size: 13px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    
    .items-table-compact input:disabled,
    .items-table-compact select:disabled {
      background-color: #e0e0e0;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .items-table-compact .remove-item-btn {
      background-color: var(--danger-color);
      color: white;
      border: none;
      padding: 3px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .items-table-compact .remove-item-btn:hover {
      background-color: #c0392b;
    }
    
    /* Work Order List Table - Compact for right panel */
    .workorder-list-table {
      width: 100%;
      font-size: 13px;
    }
    
    .workorder-list-table th {
      background-color: var(--secondary-color);
      color: white;
      padding: 6px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    .workorder-list-table td {
      padding: 6px;
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
    }
    
    .workorder-list-table td:not(:nth-child(5)) {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }
    
    /* Allow full display for work order number */
    .workorder-list-table td:first-child {
      max-width: none;
      font-weight: 600;
    }
    
    .workorder-list-table .table-actions {
      display: flex;
      gap: 2px;
    }
    
    .workorder-list-table .btn-sm {
      padding: 2px 5px;
      font-size: 11px;
    }
    
    .workorder-list-table .btn-sm .material-icons {
      font-size: 14px;
    }
    
    /* Adjust card styles for work order page */
    .workorder-layout .card {
      margin-bottom: 15px;
    }
    
    .workorder-layout .card-header {
      padding: 12px 15px;
      margin-bottom: 15px;
    }
    
    .workorder-layout .card-header h2 {
      font-size: 18px;
    }
    
    .workorder-layout .form-group {
      margin-bottom: 12px;
    }
    
    .workorder-layout .form-group label {
      font-size: 14px;
      margin-bottom: 3px;
    }
    
    .workorder-layout .form-control {
      padding: 8px 10px;
      font-size: 14px;
    }
    
    /* Right panel specific styles */
    .workorder-right .card {
      margin-bottom: 12px;
    }
    
    .workorder-right .card-header {
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    
    .workorder-right .card-header h2 {
      font-size: 16px;
    }
    
    /* Hide some columns in compact view */
    @media (max-width: 1600px) {
      .workorder-list-table td:nth-child(3),
      .workorder-list-table th:nth-child(3) {
        display: none;
      }
    }
    
    /* Responsive for smaller screens */
    @media (max-width: 1200px) {
      .workorder-layout {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .workorder-left,
      .workorder-right {
        overflow-y: visible;
        padding: 0;
        max-height: none;
      }
    }
    
    /* Auto-calculate helper in compact table */
    .items-table-compact .auto-calculate {
      color: var(--success-color);
      font-size: 10px;
      margin-top: 1px;
    }
    
    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      color: white;
    }
    
    .badge-primary { background-color: var(--primary-color); }
    .badge-success { background-color: var(--success-color); }
    .badge-warning { background-color: var(--warning-color); }
    .badge-danger { background-color: var(--danger-color); }
    .badge-info { background-color: var(--info-color); }
    .badge-secondary { background-color: var(--text-secondary); }
    
    /* System Status */
    .system-status {
      position: fixed;
      top: 70px;
      right: 20px;
      padding: 8px 12px;
      border-radius: 4px;
      z-index: 1001;
      font-size: 12px;
      box-shadow: var(--shadow-md);
      display: none;
    }
    
    .system-status.success {
      background-color: var(--success-color);
      color: white;
    }
    
    .system-status.warning {
      background-color: var(--warning-color);
      color: white;
    }
    
    .system-status.danger {
      background-color: var(--danger-color);
      color: white;
    }
    
    /* Error State */
    .error-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .error-state .material-icons {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    /* Customer Search Modal Styles */
    .customer-search-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .customer-search-wrapper input {
      flex: 1;
    }
    
    .customer-search-modal .modal-content {
      max-width: 800px;
      width: 80%;
      max-height: 600px;
    }
    
    .customer-search-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 16px;
    }
    
    .customer-search-results {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .customer-result-item {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .customer-result-item:hover {
      background-color: var(--bg-color);
    }
    
    .customer-result-item:last-child {
      border-bottom: none;
    }
    
    /* Timeline Styles */
    .timeline {
      position: relative;
      padding: 20px 0;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 20px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: var(--border-color);
    }
    
    .timeline-item {
      position: relative;
      padding-left: 50px;
      margin-bottom: 20px;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 14px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--primary-color);
      border: 2px solid var(--bg-secondary);
    }
    
    .timeline-content {
      background-color: var(--bg-color);
      padding: 15px;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }
    
    .timeline-date {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    
    /* Service Type Info Box */
    .service-type-info {
      background-color: var(--info-color);
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .service-type-info .material-icons {
      font-size: 20px;
    }
    
    /* Checkbox Styles for Email Form */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px;
      background: var(--bg-color);
      border-radius: 4px;
      transition: var(--transition);
    }
    
    .checkbox-label:hover {
      background: var(--border-color);
    }
    
    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }
    
    /* Print styles for work order */
    @media print {
      body {
        margin: 0;
        font-family: 'Sarabun', sans-serif;
      }
      
      .no-print {
        display: none !important;
      }
      
      .page-break {
        page-break-before: always;
      }
      
      /* Force single page for work order */
      .print-container {
        page-break-inside: avoid;
        width: 100%;
        max-width: 210mm;
        margin: 0 auto;
      }
      
      /* Reduce font sizes for print */
      .print-container h1 {
        font-size: 22px !important;
      }
      
      .print-container h3 {
        font-size: 16px !important;
      }
      
      .print-container table {
        font-size: 11px !important;
      }
      
      .print-container .info-item {
        font-size: 12px !important;
      }
      
      /* Compact sections for print */
      .print-container .section {
        margin-bottom: 10px !important;
        padding: 10px !important;
      }
      
      .print-container .header {
        margin-bottom: 15px !important;
        padding-bottom: 10px !important;
      }
      
      /* Reduce table padding */
      .print-container th,
      .print-container td {
        padding: 4px !important;
      }
    }
    
    /* Utility Classes */
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-secondary); }
    .text-danger { color: var(--danger-color); }
    .text-success { color: var(--success-color); }
    .text-warning { color: var(--warning-color); }
    
    .mt-1 { margin-top: 5px; }
    .mt-2 { margin-top: 10px; }
    .mt-3 { margin-top: 15px; }
    .mt-4 { margin-top: 20px; }
    
    .mb-1 { margin-bottom: 5px; }
    .mb-2 { margin-bottom: 10px; }
    .mb-3 { margin-bottom: 15px; }
    .mb-4 { margin-bottom: 20px; }
    
    .hidden { display: none !important; }
    
    /* Adjust button sizes in work order page */
    .workorder-layout .btn {
      padding: 8px 14px;
      font-size: 14px;
    }
    
    .workorder-layout .btn .material-icons {
      font-size: 18px;
    }
    
    .workorder-layout .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }
    
    .workorder-layout .btn-sm .material-icons {
      font-size: 16px;
    }
    
    /* Search box in right panel */
    .workorder-right .search-box {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .workorder-right .search-box input {
      flex: 1;
      padding: 6px 10px;
      font-size: 13px;
    }
    
    .workorder-right .search-box .btn {
      padding: 6px 10px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 10px;
      }
      
      .nav {
        justify-content: center;
      }
      
      .nav-btn {
        flex: 1;
        min-width: 120px;
        justify-content: center;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .modal-content {
        margin: 20px;
        width: calc(100% - 40px);
      }
      
      .toast {
        right: 10px;
        left: 10px;
        max-width: none;
      }
      
      /* Work order page on mobile */
      .workorder-layout {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .workorder-left,
      .workorder-right {
        overflow-y: visible;
        padding: 0;
      }
      
      .workorder-items-container {
        max-height: none;
        overflow-x: auto;
      }
      
      .items-table-compact {
        min-width: 800px;
      }
      
      .workorder-list-table {
        min-width: 700px;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>Insurance Sale Management</h1>
      <div class="header-actions">
        <button class="theme-toggle" id="theme-toggle-btn" title="เปลี่ยนธีม">
          <span class="material-icons" id="theme-icon">dark_mode</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- System Status -->
  <div class="system-status" id="system-status"></div>
  
  <!-- Main Container -->
  <div class="container">
    <!-- Navigation -->
    <div class="nav">
      <button class="nav-btn active" data-page="dashboard">
        <span class="material-icons">dashboard</span>
        หน้าหลัก
      </button>
      <button class="nav-btn" data-page="customer">
        <span class="material-icons">people</span>
        ลูกค้าและทรัพย์สิน
      </button>
      <button class="nav-btn" data-page="workorder">
        <span class="material-icons">assignment</span>
        สร้างใบงาน
      </button>
      <button class="nav-btn" data-page="history">
        <span class="material-icons">history</span>
        ประวัติ
      </button>
      <button class="nav-btn" data-page="settings">
        <span class="material-icons">settings</span>
        ตั้งค่า
      </button>
      <!-- New Navigation Buttons -->
      <button class="nav-btn" data-page="installment">
        <span class="material-icons">payments</span>
        ติดตามผ่อน
      </button>
      <button class="nav-btn" data-page="renewal">
        <span class="material-icons">autorenew</span>
        ต่ออายุ
      </button>
    </div>
    
    <!-- Dashboard Page -->
    <div id="dashboard-page" class="page active">
      <div class="dashboard-grid">
        <div class="stat-card blue" data-page="customer">
          <span class="material-icons" style="font-size: 48px; color: var(--primary-color);">people</span>
          <h3 id="stat-customers">0</h3>
          <p>ลูกค้าทั้งหมด</p>
        </div>
        <div class="stat-card green" data-page="workorder">
          <span class="material-icons" style="font-size: 48px; color: var(--success-color);">assignment</span>
          <h3 id="stat-workorders">0</h3>
          <p>ใบงานทั้งหมด</p>
        </div>
        <div class="stat-card orange">
          <span class="material-icons" style="font-size: 48px; color: var(--warning-color);">account_balance_wallet</span>
          <h3 id="stat-revenue">฿0</h3>
          <p>มูลค่ารวม</p>
        </div>
        <div class="stat-card red">
          <span class="material-icons" style="font-size: 48px; color: var(--danger-color);">warning</span>
          <h3 id="stat-expiring">0</h3>
          <p>ใกล้หมดอายุ (30 วัน)</p>
        </div>
      </div>
      
      <!-- Service Type Statistics -->
      <div class="card">
        <div class="card-header">
          <h2>สถิติแยกตามประเภทบริการ</h2>
          <button class="btn btn-info btn-sm" id="refresh-stats-btn">
            <span class="material-icons">refresh</span>
            รีเฟรช
          </button>
        </div>
        <div id="service-type-stats">
          <p class="text-center text-muted">กำลังโหลดข้อมูล...</p>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h2>เมนูลัด</h2>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="add-customer-btn">
            <span class="material-icons">person_add</span>
            เพิ่มลูกค้าใหม่
          </button>
          <button class="btn btn-success" data-page="workorder">
            <span class="material-icons">add_circle</span>
            สร้างใบงานใหม่
          </button>
          <button class="btn btn-danger" id="backup-btn">
            <span class="material-icons">backup</span>
            สำรองข้อมูล
          </button>
          <button class="btn btn-warning" id="test-connection-btn">
            <span class="material-icons">bug_report</span>
            ทดสอบระบบ
          </button>
        </div>
      </div>
    </div>
    
    <!-- Customer Management Page -->
    <div id="customer-page" class="page">
      <div class="sub-menu">
        <button class="sub-menu-btn active" data-subpage="customer-list">รายชื่อลูกค้า</button>
        <button class="sub-menu-btn" data-subpage="vehicle-list">ข้อมูลรถ</button>
        <button class="sub-menu-btn" data-subpage="property-list">ข้อมูลทรัพย์สิน</button>
      </div>
      
      <!-- Customer List -->
      <div id="customer-list" class="sub-page">
        <div class="card">
          <div class="card-header">
            <h2>จัดการข้อมูลลูกค้า</h2>
            <div class="btn-group">
              <button class="btn btn-primary" id="add-customer-list-btn">
                <span class="material-icons">add</span>
                เพิ่มลูกค้าใหม่
              </button>
              <button class="btn btn-info" id="refresh-customer-btn">
                <span class="material-icons">refresh</span>
                รีเฟรช
              </button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>รหัสลูกค้า</th>
                  <th>ชื่อ-นามสกุล</th>
                  <th>เบอร์โทร</th>
                  <th>อีเมล</th>
                  <th>สถานะ</th>
                  <th>การกระทำ</th>
                </tr>
              </thead>
              <tbody id="customer-tbody">
                <tr>
                  <td colspan="6" style="text-align: center; color: var(--text-secondary);">กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Vehicle List -->
      <div id="vehicle-list" class="sub-page" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2>จัดการข้อมูลรถ</h2>
            <div class="btn-group">
              <button class="btn btn-primary" id="add-vehicle-btn">
                <span class="material-icons">add</span>
                เพิ่มรถใหม่
              </button>
              <button class="btn btn-info" id="refresh-vehicle-btn">
                <span class="material-icons">refresh</span>
                รีเฟรช
              </button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>รหัสรถ</th>
                  <th>ทะเบียนรถ</th>
                  <th>ยี่ห้อ/รุ่น</th>
                  <th>สี</th>
                  <th>ปีรถ</th>
                  <th>เจ้าของ</th>
                  <th>การกระทำ</th>
                </tr>
              </thead>
              <tbody id="vehicle-tbody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-secondary);">กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Property List -->
      <div id="property-list" class="sub-page" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2>จัดการข้อมูลทรัพย์สิน</h2>
            <div class="btn-group">
              <button class="btn btn-primary" id="add-property-btn">
                <span class="material-icons">add</span>
                เพิ่มทรัพย์สินใหม่
              </button>
              <button class="btn btn-info" id="refresh-property-btn">
                <span class="material-icons">refresh</span>
                รีเฟรช
              </button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>รหัสทรัพย์สิน</th>
                  <th>ประเภท</th>
                  <th>ชื่อทรัพย์สิน</th>
                  <th>ที่อยู่</th>
                  <th>มูลค่า</th>
                  <th>ประเภทรถ</th>
                  <th>รหัสรถ</th>
                  <th>เจ้าของ</th>
                  <th>การกระทำ</th>
                </tr>
              </thead>
              <tbody id="property-tbody">
                <tr>
                  <td colspan="9" style="text-align: center; color: var(--text-secondary);">กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Work Order Page -->
    <div id="workorder-page" class="page">
      <div class="workorder-layout">
        <!-- Left Column: Create Work Order (2/3) -->
        <div class="workorder-left">
          <div class="card">
            <div class="card-header">
              <h2>สร้างใบงานใหม่</h2>
              <button class="btn btn-info btn-sm" id="reset-workorder-btn">
                <span class="material-icons">refresh</span>
                เริ่มใหม่
              </button>
            </div>
            
            <!-- Service Type Info -->
            <div class="service-type-info">
              <span class="material-icons">info</span>
              <span>รายการแต่ละประเภทบริการจะถูกบันทึกแยกในชีทที่เกี่ยวข้อง เช่น ประกันภัย, ภาษี, ค่าบริการ</span>
            </div>
            
            <form id="workorder-form">
              <div class="form-grid">
                <div class="form-group">
                  <label>เลขที่ใบงาน</label>
                  <input type="text" class="form-control" id="wo-number" readonly style="background-color: var(--bg-color); font-weight: bold;">
                  <div class="text-muted" style="font-size: 12px;">สร้างอัตโนมัติ</div>
                </div>
                <div class="form-group">
                  <label>วันที่สร้าง</label>
                  <input type="date" class="form-control" id="wo-date" readonly style="background-color: var(--bg-color);">
                </div>
              </div>
              
              <div class="form-group">
                <label>ค้นหาลูกค้า *</label>
                <div class="autocomplete-wrapper">
                  <input type="text" class="form-control" id="wo-customer-search" placeholder="พิมพ์ชื่อ, เบอร์โทร หรือเลขบัตรประชาชน" required>
                  <input type="hidden" id="wo-customer-id">
                  <div class="autocomplete-dropdown" id="customer-autocomplete"></div>
                </div>
              </div>
              
              <div class="form-group">
                <label>ข้อมูลลูกค้า</label>
                <div id="selected-customer-info" style="padding: 10px; background-color: var(--bg-color); border-radius: 4px; font-size: 14px;">
                  <span class="text-muted">กรุณาเลือกลูกค้า</span>
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label>ประเภททรัพย์สิน *</label>
                  <select class="form-control" id="wo-asset-type" required>
                    <option value="">-- เลือกประเภท --</option>
                    <option value="vehicle">รถยนต์</option>
                    <option value="property">ทรัพย์สินอื่นๆ</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>เลือกทรัพย์สิน</label>
                  <select class="form-control" id="wo-asset" disabled>
                    <option value="">-- เลือกทรัพย์สิน --</option>
                  </select>
                </div>
              </div>
              
              <!-- Work Order Items -->
              <h4 style="margin-top: 20px; margin-bottom: 10px;">รายการในใบงาน</h4>
              <div class="workorder-items-container">
                <table class="items-table-compact">
                  <thead>
                    <tr>
                      <th>ประเภทบริการ</th>
                      <th>ประเภทประกัน</th>
                      <th>รายละเอียด</th>
                      <th>ทุนประกัน</th>
                      <th>เบี้ยประกัน</th>
                      <th>วันเริ่ม</th>
                      <th>วันสิ้นสุด</th>
                      <th>เลขกรมธรรม์</th>
                      <th>บริษัทประกัน</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="work-order-items">
                    <!-- Items will be added here -->
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="4" style="text-align: right;"><strong>รวมเบี้ยประกัน:</strong></td>
                      <td><strong id="total-premium">0.00</strong></td>
                      <td colspan="5"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              <button type="button" class="btn btn-success btn-sm mt-2" id="add-item-btn">
                <span class="material-icons">add</span>
                เพิ่มรายการ
              </button>
              
              <!-- Payment Section -->
              <h4 style="margin-top: 20px; margin-bottom: 10px;">ข้อมูลการชำระเงิน</h4>
              <div class="card" style="background-color: var(--bg-color); padding: 15px;">
                <div class="form-grid">
                  <div class="form-group">
                    <label>ประเภทการชำระเงิน *</label>
                    <select class="form-control" id="wo-payment-type" required>
                      <option value="">-- เลือกประเภท --</option>
                      <option value="โอนเงิน">โอนเงิน</option>
                      <option value="บัตรเครดิต">บัตรเครดิต</option>
                      <option value="เงินสด">เงินสด</option>
                      <option value="ผ่อนชำระ">ผ่อนชำระ</option>
                    </select>
                  </div>
                  <div class="form-group" id="installment-group" style="display: none;">
                    <label>จำนวนงวด</label>
                    <select class="form-control" id="wo-installments">
                      <option value="">-- เลือกจำนวนงวด --</option>
                      <option value="2">2 งวด</option>
                      <option value="3">3 งวด</option>
                      <option value="4">4 งวด</option>
                      <option value="5">5 งวด</option>
                      <option value="6">6 งวด</option>
                    </select>
                  </div>
                  <div class="form-group" id="payment-reference-group">
                    <label>เลขที่อ้างอิง/เลขที่บัตร</label>
                    <input type="text" class="form-control" id="wo-payment-reference" placeholder="เลขที่อ้างอิงการโอน/4 หลักท้ายบัตร">
                  </div>
                  <div class="form-group" id="payment-date-group">
                    <label>วันที่ชำระเงิน</label>
                    <input type="date" class="form-control" id="wo-payment-date">
                  </div>
                  <div class="form-group" id="bank-group" style="display: none;">
                    <label>ธนาคาร</label>
                    <select class="form-control" id="wo-bank">
                      <option value="">-- เลือกธนาคาร --</option>
                      <option value="กรุงเทพ">ธนาคารกรุงเทพ</option>
                      <option value="กสิกรไทย">ธนาคารกสิกรไทย</option>
                      <option value="ไทยพาณิชย์">ธนาคารไทยพาณิชย์</option>
                      <option value="กรุงไทย">ธนาคารกรุงไทย</option>
                      <option value="ทหารไทยธนชาต">ธนาคารทหารไทยธนชาต</option>
                      <option value="กรุงศรี">ธนาคารกรุงศรี</option>
                      <option value="ออมสิน">ธนาคารออมสิน</option>
                      <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                  </div>
                </div>
                
                <!-- Installment Plan Display -->
                <div id="installment-plan" style="display: none; margin-top: 15px;">
                  <h5>แผนการผ่อนชำระ</h5>
                  <div class="table-container">
                    <table class="items-table-compact">
                      <thead>
                        <tr>
                          <th>งวดที่</th>
                          <th>จำนวนเงิน</th>
                          <th>วันครบกำหนด</th>
                          <th>สถานะ</th>
                        </tr>
                      </thead>
                      <tbody id="installment-plan-body">
                        <!-- Installment rows will be generated here -->
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="form-group">
                  <label>หมายเหตุการชำระเงิน</label>
                  <textarea class="form-control" id="wo-payment-notes" rows="2" placeholder="หมายเหตุเพิ่มเติม..."></textarea>
                </div>
              </div>
              
              <div style="text-align: center; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">
                  <span class="material-icons">save</span>
                  บันทึกใบงาน
                </button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- Right Column: Search and List (1/3) -->
        <div class="workorder-right">
          <!-- Search Work Order Card -->
          <div class="card">
            <div class="card-header">
              <h2>ค้นหาใบงาน</h2>
            </div>
            <div class="search-box">
              <input type="text" class="form-control" id="search-workorder" placeholder="ค้นหา...">
              <button class="btn btn-primary btn-sm" id="search-wo-btn">
                <span class="material-icons">search</span>
              </button>
              <button class="btn btn-info btn-sm" id="clear-search-btn">
                <span class="material-icons">clear</span>
              </button>
            </div>
          </div>
          
          <!-- Work Order List -->
          <div class="card">
            <div class="card-header">
              <h2>รายการใบงานล่าสุด</h2>
              <div class="btn-group">
                <button class="btn btn-info btn-sm" id="refresh-wo-list-btn">
                  <span class="material-icons">refresh</span>
                </button>
                <button class="btn btn-primary btn-sm" id="print-wo-summary-btn" title="พิมพ์สรุป">
                  <span class="material-icons">print</span>
                </button>
              </div>
            </div>
            <div class="table-container">
              <table class="workorder-list-table">
                <thead>
                  <tr>
                    <th>เลขที่</th>
                    <th>วันที่</th>
                    <th>ลูกค้า</th>
                    <th>เบี้ย</th>
                    <th>สถานะ</th>
                    <th>จัดการ</th>
                  </tr>
                </thead>
                <tbody id="workorder-tbody">
                  <tr>
                    <td colspan="6" class="text-center text-muted">กำลังโหลด...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- History Page -->
    <div id="history-page" class="page">
      <div class="card">
        <div class="card-header">
          <h2>ประวัติการทำงาน</h2>
          <button class="btn btn-primary" id="refresh-history-btn">
            <span class="material-icons">refresh</span>
            รีเฟรช
          </button>
        </div>
        <div class="timeline" id="history-timeline">
          <!-- History items will be loaded here -->
        </div>
      </div>
    </div>
    
    <!-- Settings Page -->
    <div id="settings-page" class="page">
      <div class="card">
        <div class="card-header">
          <h2>ตั้งค่าระบบ</h2>
        </div>
        <div class="form-group">
          <label>ชื่อบริษัท</label>
          <input type="text" class="form-control" id="company-name" value="Insurance Sale Management">
        </div>
        <div class="form-group">
          <label>อีเมลแจ้งเตือน</label>
          <input type="email" class="form-control" id="notification-email" placeholder="your-email@gmail.com">
        </div>
        <div class="form-group">
          <label>อีเมลพนักงาน (สำหรับ CC อัตโนมัติ)</label>
          <input type="email" class="form-control" id="employee-email" placeholder="employee@company.com">
          <small class="text-muted">อีเมลนี้จะถูกใส่ใน CC อัตโนมัติเมื่อส่งอีเมลแจ้งงาน</small>
        </div>
        <div class="btn-group mt-4">
          <button class="btn btn-primary" id="save-settings-btn">
            <span class="material-icons">save</span>
            บันทึกการตั้งค่า
          </button>
          <button class="btn btn-warning" id="test-system-btn">
            <span class="material-icons">bug_report</span>
            ทดสอบการเชื่อมต่อ
          </button>
          <button class="btn btn-danger" id="backup-system-btn">
            <span class="material-icons">backup</span>
            สำรองข้อมูล
          </button>
          <button class="btn btn-info" id="init-system-btn">
            <span class="material-icons">build</span>
            เริ่มต้นระบบ
          </button>
        </div>
      </div>
      
      <div class="card mt-4">
        <div class="card-header">
          <h2>ข้อมูลระบบ</h2>
        </div>
        <div id="system-info">
          <p class="text-muted">กำลังโหลดข้อมูลระบบ...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Customer Modal -->
  <div class="modal" id="customer-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>เพิ่ม/แก้ไขข้อมูลลูกค้า</h3>
        <button class="close-btn" data-modal="customer-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="customer-form">
          <input type="hidden" id="customer-id">
          <div class="form-grid">
            <div class="form-group">
              <label>ชื่อ-นามสกุล *</label>
              <input type="text" class="form-control" id="customer-name" required>
            </div>
            <div class="form-group">
              <label>เลขบัตรประชาชน</label>
              <input type="text" class="form-control" id="customer-idcard" maxlength="13">
            </div>
            <div class="form-group">
              <label>เบอร์โทร</label>
              <input type="tel" class="form-control" id="customer-phone">
            </div>
            <div class="form-group">
              <label>อีเมล</label>
              <input type="email" class="form-control" id="customer-email">
            </div>
            <div class="form-group">
              <label>ที่อยู่จัดส่ง</label>
              <textarea class="form-control" id="customer-shipping" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>ที่อยู่ตามเอกสาร</label>
              <textarea class="form-control" id="customer-document" rows="2"></textarea>
            </div>
          </div>
          <div class="form-group">
            <label>หมายเหตุ</label>
            <textarea class="form-control" id="customer-notes" rows="2" style="width: 100%;"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" data-modal="customer-modal">ยกเลิก</button>
        <button class="btn btn-primary" id="save-customer-btn">
          <span class="material-icons">save</span>
          บันทึก
        </button>
      </div>
    </div>
  </div>
  
  <!-- Vehicle Modal -->
  <div class="modal" id="vehicle-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>เพิ่ม/แก้ไขข้อมูลรถ</h3>
        <button class="close-btn" data-modal="vehicle-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="vehicle-form">
          <input type="hidden" id="vehicle-id">
          <div class="form-group">
            <label>เจ้าของ *</label>
            <div class="customer-search-wrapper">
              <input type="text" class="form-control" id="vehicle-owner-search" placeholder="ค้นหาเจ้าของ" required readonly>
              <input type="hidden" id="vehicle-owner">
              <button type="button" class="btn btn-primary" id="vehicle-owner-btn">
                <span class="material-icons">search</span>
              </button>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>ทะเบียนรถ *</label>
              <input type="text" class="form-control" id="vehicle-license" required>
            </div>
            <div class="form-group">
              <label>ยี่ห้อ</label>
              <input type="text" class="form-control" id="vehicle-brand">
            </div>
            <div class="form-group">
              <label>รุ่น</label>
              <input type="text" class="form-control" id="vehicle-model">
            </div>
            <div class="form-group">
              <label>สี</label>
              <input type="text" class="form-control" id="vehicle-color">
            </div>
            <div class="form-group">
              <label>ปีรถ</label>
              <input type="number" class="form-control" id="vehicle-year" min="1900" max="2100">
            </div>
            <div class="form-group">
              <label>เลขตัวถัง</label>
              <input type="text" class="form-control" id="vehicle-chassis">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" data-modal="vehicle-modal">ยกเลิก</button>
        <button class="btn btn-primary" id="save-vehicle-btn">
          <span class="material-icons">save</span>
          บันทึก
        </button>
      </div>
    </div>
  </div>
  
  <!-- Property Modal -->
  <div class="modal" id="property-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>เพิ่ม/แก้ไขข้อมูลทรัพย์สิน</h3>
        <button class="close-btn" data-modal="property-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="property-form">
          <input type="hidden" id="property-id">
          <div class="form-group">
            <label>เจ้าของ *</label>
            <div class="customer-search-wrapper">
              <input type="text" class="form-control" id="property-owner-search" placeholder="ค้นหาเจ้าของ" required readonly>
              <input type="hidden" id="property-owner">
              <button type="button" class="btn btn-primary" id="property-owner-btn">
                <span class="material-icons">search</span>
              </button>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>ประเภท *</label>
              <select class="form-control" id="property-type" required>
                <option value="">-- เลือกประเภท --</option>
                <option value="บ้าน">บ้าน</option>
                <option value="โรงงาน">โรงงาน</option>
                <option value="อาคารพาณิชย์">อาคารพาณิชย์</option>
                <option value="ที่ดิน">ที่ดิน</option>
                <option value="อื่นๆ">อื่นๆ</option>
              </select>
            </div>
            <div class="form-group">
              <label>ชื่อทรัพย์สิน *</label>
              <input type="text" class="form-control" id="property-name" required>
            </div>
            <div class="form-group">
              <label>มูลค่า</label>
              <input type="number" class="form-control" id="property-value" min="0" step="0.01">
            </div>
            <div class="form-group">
              <label>ประเภทรถ</label>
              <select class="form-control" id="property-vehicle-type">
                <option value="">-- เลือกประเภทรถ --</option>
                <option value="รถเก๋ง">รถเก๋ง</option>
                <option value="รถกระบะ">รถกระบะ</option>
                <option value="รถตู้">รถตู้</option>
                <option value="รถ SUV">รถ SUV</option>
                <option value="รถบรรทุก">รถบรรทุก</option>
                <option value="รถจักรยานยนต์">รถจักรยานยนต์</option>
                <option value="อื่นๆ">อื่นๆ</option>
              </select>
            </div>
            <div class="form-group">
              <label>รหัสรถ</label>
              <input type="text" class="form-control" id="property-vehicle-code" placeholder="เช่น CAR001">
            </div>
            <div class="form-group">
              <label>ที่อยู่</label>
              <textarea class="form-control" id="property-address" rows="2"></textarea>
            </div>
          </div>
          <div class="form-group">
            <label>รายละเอียด</label>
            <textarea class="form-control" id="property-description" rows="2" style="width: 100%;"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" data-modal="property-modal">ยกเลิก</button>
        <button class="btn btn-primary" id="save-property-btn">
          <span class="material-icons">save</span>
          บันทึก
        </button>
      </div>
    </div>
  </div>
  
  <!-- Customer Search Modal for Vehicle Owner -->
  <div class="modal customer-search-modal" id="vehicle-owner-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ค้นหาเจ้าของรถ</h3>
        <button class="close-btn" data-modal="vehicle-owner-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>ค้นหาลูกค้า</label>
          <input type="text" class="form-control customer-search-input" id="vehicle-owner-search-input" placeholder="พิมพ์ชื่อ, เบอร์โทร หรือเลขบัตรประชาชน">
        </div>
        <div class="customer-search-results" id="vehicle-owner-results">
          <p class="text-center text-muted">พิมพ์อย่างน้อย 2 ตัวอักษรเพื่อค้นหา</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Customer Search Modal for Property Owner -->
  <div class="modal customer-search-modal" id="property-owner-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ค้นหาเจ้าของทรัพย์สิน</h3>
        <button class="close-btn" data-modal="property-owner-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>ค้นหาลูกค้า</label>
          <input type="text" class="form-control customer-search-input" id="property-owner-search-input" placeholder="พิมพ์ชื่อ, เบอร์โทร หรือเลขบัตรประชาชน">
        </div>
        <div class="customer-search-results" id="property-owner-results">
          <p class="text-center text-muted">พิมพ์อย่างน้อย 2 ตัวอักษรเพื่อค้นหา</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Confirmation Modal -->
  <div class="modal" id="confirm-modal">
    <div class="modal-content" style="max-width: 600px; width: 50%;">
      <div class="modal-header">
        <h3 id="confirm-title">ยืนยันการดำเนินการ</h3>
        <button class="close-btn" data-modal="confirm-modal">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirm-message">คุณแน่ใจหรือไม่ที่จะดำเนินการนี้?</p>
      </div>
      <div class="modal-footer">
        <button class="btn" data-modal="confirm-modal">ยกเลิก</button>
        <button class="btn btn-danger" id="confirm-button">ยืนยัน</button>
      </div>
    </div>
  </div>
  
  <!-- Search Results Modal -->
  <div class="modal" id="search-results-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ผลการค้นหา</h3>
        <button class="close-btn" data-modal="search-results-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="search-results-content">
          <!-- Search results will be displayed here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <div>กำลังดำเนินการ...</div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <script>
    // ==================== IMMEDIATE INITIALIZATION ====================
    console.log('Script starting...');
    
    // ==================== GLOBAL VARIABLES ====================
    let customers = [];
    let vehicles = [];
    let properties = [];
    let workOrders = [];
    let companies = [];
    let history = [];
    let currentUser = '';
    let workOrderItems = [];
    let selectedCustomer = null;
    let systemInitialized = false;
    let connectionStatus = 'unknown';
    const DISPLAY_LIMIT = 5;
    
    // Configuration
    const CONFIG = {
      TIMEOUT_DURATION: 10000,
      RETRY_ATTEMPTS: 3,
      AUTO_SAVE_INTERVAL: 30000,
      MAX_SEARCH_RESULTS: 50
    };
    
    // Service Type to Sheet Name mapping
    const SERVICE_SHEET_MAPPING = {
      'ประกันภัย': 'ประกันภัย',
      'พรบ': 'ประกันภัย',
      'ภาษีรถ': 'ภาษี',
      'ค่าตรวจสภาพรถ': 'ค่าบริการ',
      'ค่าบริการ': 'ค่าบริการ',
      'อื่นๆ': 'อื่นๆ'
    };
    
    // ==================== GLOBAL VARIABLES FOR INSTALLMENT EDITING ====================
    let installmentPlanData = [];
    
    // ==================== BASIC UTILITY FUNCTIONS ====================
    function showLoading(message = 'กำลังดำเนินการ...') {
      try {
        const loading = document.getElementById('loading');
        if (loading) {
          loading.style.display = 'block';
          loading.innerHTML = `
            <div class="loading-spinner"></div>
            <div>${message}</div>
          `;
        }
      } catch (error) {
        console.error('Error in showLoading:', error);
      }
    }
    
    function hideLoading() {
      try {
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'none';
      } catch (error) {
        console.error('Error in hideLoading:', error);
      }
    }
    
    function showToast(message, type = 'success') {
      try {
        const toast = document.getElementById('toast');
        if (toast) {
          toast.textContent = message;
          toast.className = 'toast ' + type;
          toast.style.display = 'block';
          
          setTimeout(() => {
            toast.style.display = 'none';
          }, 5000);
        }
      } catch (error) {
        console.error('Error in showToast:', error);
        alert(message);
      }
    }
    
    function updateSystemStatus(type, message) {
      const statusEl = document.getElementById('system-status');
      if (statusEl) {
        statusEl.className = `system-status ${type}`;
        statusEl.textContent = message;
        statusEl.style.display = 'block';
        
        if (type === 'success') {
          setTimeout(() => {
            statusEl.style.display = 'none';
          }, 3000);
        }
      }
    }
    
    // ==================== NAVIGATION FUNCTIONS ====================
    function showPage(pageName) {
      try {
        console.log('Showing page:', pageName);
        
        // Update navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.getAttribute('data-page') === pageName) {
            btn.classList.add('active');
          }
        });
        
        // Show page
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        const targetPage = document.getElementById(pageName + '-page');
        if (targetPage) {
          targetPage.classList.add('active');
        } else {
          console.error('Page not found:', pageName);
          return;
        }
        
        // Load page data
        loadPageData(pageName);
      } catch (error) {
        console.error('Error in showPage:', error);
        showToast('เกิดข้อผิดพลาดในการแสดงหน้า', 'error');
      }
    }
    
    function showSubPage(subPageName) {
      try {
        console.log('Showing sub-page:', subPageName);
        
        // Update sub menu
        document.querySelectorAll('.sub-menu-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.getAttribute('data-subpage') === subPageName) {
            btn.classList.add('active');
          }
        });
        
        // Show sub page
        document.querySelectorAll('.sub-page').forEach(page => {
          page.style.display = 'none';
        });
        
        const targetSubPage = document.getElementById(subPageName);
        if (targetSubPage) {
          targetSubPage.style.display = 'block';
        }
        
        // Load sub page data
        loadSubPageData(subPageName);
      } catch (error) {
        console.error('Error in showSubPage:', error);
      }
    }
    
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'none';
    }
    
    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
      const isDark = document.body.classList.contains('dark-theme');
      document.getElementById('theme-icon').textContent = isDark ? 'light_mode' : 'dark_mode';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    // ==================== EVENT LISTENERS SETUP ====================
    function setupEventListeners() {
      console.log('Setting up event listeners...');
      
      // Navigation buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const pageName = this.getAttribute('data-page');
          if (pageName) showPage(pageName);
        });
      });
      
      // Sub-navigation buttons
      document.querySelectorAll('.sub-menu-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const subPageName = this.getAttribute('data-subpage');
          if (subPageName) showSubPage(subPageName);
        });
      });
      
      // Modal close buttons
      document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const modalId = this.getAttribute('data-modal');
          if (modalId) closeModal(modalId);
        });
      });
      
      // Modal cancel buttons
      document.querySelectorAll('.btn[data-modal]').forEach(btn => {
        btn.addEventListener('click', function() {
          const modalId = this.getAttribute('data-modal');
          if (modalId) closeModal(modalId);
        });
      });
      
      // Stat cards navigation
      document.querySelectorAll('.stat-card[data-page]').forEach(card => {
        card.addEventListener('click', function() {
          const pageName = this.getAttribute('data-page');
          if (pageName) showPage(pageName);
        });
      });
      
      // Theme toggle
      const themeToggle = document.getElementById('theme-toggle-btn');
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }
      
      // Dashboard buttons
      const addCustomerBtn = document.getElementById('add-customer-btn');
      if (addCustomerBtn) {
        addCustomerBtn.addEventListener('click', openCustomerModal);
      }
      
      const backupBtn = document.getElementById('backup-btn');
      if (backupBtn) {
        backupBtn.addEventListener('click', createBackup);
      }
      
      const testConnectionBtn = document.getElementById('test-connection-btn');
      if (testConnectionBtn) {
        testConnectionBtn.addEventListener('click', testSystemConnection);
      }
      
      const refreshStatsBtn = document.getElementById('refresh-stats-btn');
      if (refreshStatsBtn) {
        refreshStatsBtn.addEventListener('click', loadServiceTypeStats);
      }
      
      // Customer page buttons
      const addCustomerListBtn = document.getElementById('add-customer-list-btn');
      if (addCustomerListBtn) {
        addCustomerListBtn.addEventListener('click', openCustomerModal);
      }
      
      const refreshCustomerBtn = document.getElementById('refresh-customer-btn');
      if (refreshCustomerBtn) {
        refreshCustomerBtn.addEventListener('click', refreshCustomerList);
      }
      
      const saveCustomerBtn = document.getElementById('save-customer-btn');
      if (saveCustomerBtn) {
        saveCustomerBtn.addEventListener('click', saveCustomer);
      }
      
      // Vehicle page buttons
      const addVehicleBtn = document.getElementById('add-vehicle-btn');
      if (addVehicleBtn) {
        addVehicleBtn.addEventListener('click', openVehicleModal);
      }
      
      const refreshVehicleBtn = document.getElementById('refresh-vehicle-btn');
      if (refreshVehicleBtn) {
        refreshVehicleBtn.addEventListener('click', refreshVehicleList);
      }
      
      const saveVehicleBtn = document.getElementById('save-vehicle-btn');
      if (saveVehicleBtn) {
        saveVehicleBtn.addEventListener('click', saveVehicle);
      }
      
      // Property page buttons
      const addPropertyBtn = document.getElementById('add-property-btn');
      if (addPropertyBtn) {
        addPropertyBtn.addEventListener('click', openPropertyModal);
      }
      
      const refreshPropertyBtn = document.getElementById('refresh-property-btn');
      if (refreshPropertyBtn) {
        refreshPropertyBtn.addEventListener('click', refreshPropertyList);
      }
      
      const savePropertyBtn = document.getElementById('save-property-btn');
      if (savePropertyBtn) {
        savePropertyBtn.addEventListener('click', saveProperty);
      }
      
      // Work order page
      const resetWorkorderBtn = document.getElementById('reset-workorder-btn');
      if (resetWorkorderBtn) {
        resetWorkorderBtn.addEventListener('click', resetWorkOrderForm);
      }
      
      const addItemBtn = document.getElementById('add-item-btn');
      if (addItemBtn) {
        addItemBtn.addEventListener('click', addWorkOrderItem);
      }
      
      const workorderForm = document.getElementById('workorder-form');
      if (workorderForm) {
        workorderForm.addEventListener('submit', function(e) {
          e.preventDefault();
          saveWorkOrder();
        });
      }
      
      const searchWoBtn = document.getElementById('search-wo-btn');
      if (searchWoBtn) {
        searchWoBtn.addEventListener('click', searchWorkOrders);
      }
      
      const clearSearchBtn = document.getElementById('clear-search-btn');
      if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', clearWorkOrderSearch);
      }
      
      const refreshWoListBtn = document.getElementById('refresh-wo-list-btn');
      if (refreshWoListBtn) {
        refreshWoListBtn.addEventListener('click', refreshWorkOrderList);
      }
      
      const printWoSummaryBtn = document.getElementById('print-wo-summary-btn');
      if (printWoSummaryBtn) {
        printWoSummaryBtn.addEventListener('click', printWorkOrderSummary);
      }
      
      const searchWorkorderInput = document.getElementById('search-workorder');
      if (searchWorkorderInput) {
        searchWorkorderInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') searchWorkOrders();
        });
      }
      
      // Asset type change
      const assetTypeSelect = document.getElementById('wo-asset-type');
      if (assetTypeSelect) {
        assetTypeSelect.addEventListener('change', function() {
          loadAssets().catch(e => console.error('Error loading assets:', e));
        });
      }
      
      // History page
      const refreshHistoryBtn = document.getElementById('refresh-history-btn');
      if (refreshHistoryBtn) {
        refreshHistoryBtn.addEventListener('click', loadHistory);
      }
      
      // Settings page
      const saveSettingsBtn = document.getElementById('save-settings-btn');
      if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', saveSettings);
      }
      
      const testSystemBtn = document.getElementById('test-system-btn');
      if (testSystemBtn) {
        testSystemBtn.addEventListener('click', testSystemConnection);
      }
      
      const backupSystemBtn = document.getElementById('backup-system-btn');
      if (backupSystemBtn) {
        backupSystemBtn.addEventListener('click', createBackup);
      }
      
      const initSystemBtn = document.getElementById('init-system-btn');
      if (initSystemBtn) {
        initSystemBtn.addEventListener('click', initializeSystemManually);
      }
      
      // Payment type change handler
      const paymentTypeSelect = document.getElementById('wo-payment-type');
      if (paymentTypeSelect) {
        paymentTypeSelect.addEventListener('change', handlePaymentTypeChange);
      }
      
      // Installments change handler
      const installmentsSelect = document.getElementById('wo-installments');
      if (installmentsSelect) {
        installmentsSelect.addEventListener('change', generateInstallmentPlan);
      }
      
      // Payment date auto-fill
      const paymentDateInput = document.getElementById('wo-payment-date');
      if (paymentDateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        paymentDateInput.value = `${year}-${month}-${day}`;
      }
      
      // Owner search buttons
      const vehicleOwnerBtn = document.getElementById('vehicle-owner-btn');
      if (vehicleOwnerBtn) {
        vehicleOwnerBtn.addEventListener('click', function() {
          openOwnerSearchModal('vehicle');
        });
      }
      
      const propertyOwnerBtn = document.getElementById('property-owner-btn');
      if (propertyOwnerBtn) {
        propertyOwnerBtn.addEventListener('click', function() {
          openOwnerSearchModal('property');
        });
      }
      
      // Owner search inputs
      const vehicleOwnerSearchInput = document.getElementById('vehicle-owner-search-input');
      if (vehicleOwnerSearchInput) {
        vehicleOwnerSearchInput.addEventListener('input', function() {
          searchOwnersInModal('vehicle', this.value);
        });
      }
      
      const propertyOwnerSearchInput = document.getElementById('property-owner-search-input');
      if (propertyOwnerSearchInput) {
        propertyOwnerSearchInput.addEventListener('input', function() {
          searchOwnersInModal('property', this.value);
        });
      }
      
      // Installment & Renewal refresh
      const refInstBtn = document.getElementById('refresh-installment-btn');
      if (refInstBtn) refInstBtn.addEventListener('click', loadInstallmentTracking);

      const refReBtn = document.getElementById('refresh-renewal-btn');
      if (refReBtn) refReBtn.addEventListener('click', loadRenewalTracking);
      
      console.log('Event listeners setup complete');
    }
    
    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded');
      
      try {
        // Apply saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
          document.body.classList.add('dark-theme');
          const themeIcon = document.getElementById('theme-icon');
          if (themeIcon) themeIcon.textContent = 'light_mode';
        }
        
        // Load saved employee email
        const savedEmployeeEmail = localStorage.getItem('employeeEmail');
        
        // Setup event listeners first
        setupEventListeners();
        
        // Setup form handlers
        setupFormHandlers();
        
        // Setup customer autocomplete
        setupCustomerAutocomplete();
        
        // Store employee email globally
        window.EMPLOYEE_EMAIL = savedEmployeeEmail || '';
        
        // Show loading
        showLoading('กำลังเริ่มต้นระบบ...');
        
        // Test Google Script availability
        if (!window.google || !window.google.script) {
          console.error('Google Apps Script API not found');
          hideLoading();
          showSystemError('ไม่พบ Google Apps Script API - กรุณาตรวจสอบการเชื่อมต่อ');
          return;
        }
        
        console.log('Google Apps Script API found');
        
        // Initialize system
        initializeSystem();
        
      } catch (error) {
        console.error('Critical error during DOM setup:', error);
        hideLoading();
        showSystemError('เกิดข้อผิดพลาดร้ายแรง: ' + error.message);
      }
    });
    
    // ==================== GOOGLE SCRIPT API WRAPPER ====================
    function callGoogleScript(functionName, ...args) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        
        function attempt() {
          attempts++;
          console.log(`Calling ${functionName}, attempt ${attempts}`);
          
          const timeout = setTimeout(() => {
            reject(new Error(`Timeout calling ${functionName}`));
          }, CONFIG.TIMEOUT_DURATION);
          
          google.script.run
            .withSuccessHandler(function(result) {
              clearTimeout(timeout);
              console.log(`${functionName} completed successfully`);
              resolve(result);
            })
            .withFailureHandler(function(error) {
              clearTimeout(timeout);
              console.error(`${functionName} failed:`, error);
              
              if (attempts < CONFIG.RETRY_ATTEMPTS) {
                setTimeout(() => attempt(), 1000 * attempts);
              } else {
                reject(new Error(`${functionName} failed: ${error}`));
              }
            })
            [functionName](...args);
        }
        
        attempt();
      });
    }
    
    // ==================== SYSTEM INITIALIZATION ====================
    async function initializeSystem() {
      try {
        // Test connection first
        await testSystemConnection();
        
        systemInitialized = true;
        updateSystemStatus('success', 'เชื่อมต่อสำเร็จ');
        
        // Load initial data
        await loadInitialData();
        
        // Load saved employee email to settings
        if (window.EMPLOYEE_EMAIL) {
          const employeeEmailField = document.getElementById('employee-email');
          if (employeeEmailField) {
            employeeEmailField.value = window.EMPLOYEE_EMAIL;
          }
        }
        
        hideLoading();
        showToast('ระบบพร้อมใช้งาน', 'success');
        
      } catch (error) {
        hideLoading();
        console.error('Initialization failed:', error);
        showSystemError('ไม่สามารถเริ่มต้นระบบได้: ' + error.message);
      }
    }
    
    async function loadInitialData() {
      showLoading('กำลังโหลดข้อมูล...');
      
      try {
        await Promise.all([
          loadCompanies(),
          loadCustomerList(),
          loadVehicleList(),
          loadPropertyList(),
          loadWorkOrderList(),
          loadDashboard(),
          loadServiceTypeStats()
        ]);
      } catch (error) {
        console.warn('Some data failed to load:', error);
      }
    }
    
    function showSystemError(message) {
      console.error('System Error:', message);
      
      const container = document.querySelector('.container');
      if (!container) {
        alert('เกิดข้อผิดพลาดร้ายแรง: ' + message);
        return;
      }
      
      const errorHtml = `
        <div class="error-state">
          <span class="material-icons">error_outline</span>
          <h3>เกิดข้อผิดพลาด</h3>
          <p>${message}</p>
          <div class="btn-group mt-3">
            <button class="btn btn-primary" onclick="location.reload()">
              <span class="material-icons">refresh</span>
              ลองใหม่
            </button>
          </div>
        </div>
      `;
      
      container.innerHTML = errorHtml;
    }
    
    // ==================== TEST CONNECTION ====================
    async function testSystemConnection() {
      try {
        showLoading('กำลังทดสอบการเชื่อมต่อ...');
        
        const result = await callGoogleScript('testConnection');
        
        if (result && result.success) {
          connectionStatus = 'connected';
          updateSystemStatus('success', 'เชื่อมต่อสำเร็จ');
          
          // Update system info
          const systemInfo = document.getElementById('system-info');
          if (systemInfo) {
            systemInfo.innerHTML = `
              <div class="form-grid">
                <div class="form-group">
                  <label>Spreadsheet:</label>
                  <p><strong>${result.spreadsheetName}</strong></p>
                  <small><a href="${result.spreadsheetUrl}" target="_blank">เปิดใน Google Sheets</a></small>
                </div>
                <div class="form-group">
                  <label>ผู้ใช้:</label>
                  <p>${result.userEmail}</p>
                </div>
                <div class="form-group">
                  <label>สถานะ:</label>
                  <p><span class="badge badge-success">เชื่อมต่อสำเร็จ</span></p>
                </div>
              </div>
            `;
          }
          
          hideLoading();
          return result;
        } else {
          throw new Error(result?.error || 'Connection test failed');
        }
      } catch (error) {
        hideLoading();
        connectionStatus = 'disconnected';
        updateSystemStatus('danger', 'เชื่อมต่อล้มเหลว');
        throw error;
      }
    }
    
    // ==================== MANUAL SYSTEM INITIALIZATION ====================
    async function initializeSystemManually() {
      try {
        showLoading('กำลังเริ่มต้นระบบ...');
        
        const result = await callGoogleScript('initializeSystem');
        
        if (result && result.success) {
          showToast(result.message, 'success');
          await testSystemConnection();
          await loadInitialData();
        } else {
          throw new Error(result?.message || 'System initialization failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        showToast(`ไม่สามารถเริ่มต้นระบบได้: ${error.message}`, 'error');
      }
    }
    
    // ==================== LOAD PAGE DATA ====================
    function loadPageData(pageName) {
      if (!systemInitialized) {
        console.warn('System not initialized');
        return;
      }
      
      switch(pageName) {
        case 'dashboard':
          loadDashboard();
          loadServiceTypeStats();
          break;
        case 'customer':
          loadCustomerList();
          break;
        case 'workorder':
          loadWorkOrderForm();
          loadWorkOrderList();
          break;
        case 'history':
          loadHistory();
          break;
        case 'settings':
          // Settings loaded when connection tested
          break;
        case 'installment':
          loadInstallmentTracking();
          break;
        case 'renewal':
          loadRenewalTracking();
          break;
      }
    }
    
    function loadSubPageData(subPageName) {
      if (!systemInitialized) return;
      
      switch(subPageName) {
        case 'customer-list':
          loadCustomerList();
          break;
        case 'vehicle-list':
          loadVehicleList();
          break;
        case 'property-list':
          loadPropertyList();
          break;
      }
    }
    
    // ==================== DASHBOARD FUNCTIONS ====================
    async function loadDashboard() {
      if (!systemInitialized) return;
      
      try {
        const data = await callGoogleScript('getDashboardData');
        
        document.getElementById('stat-customers').textContent = data.totalCustomers || 0;
        document.getElementById('stat-workorders').textContent = data.totalWorkOrders || 0;
        document.getElementById('stat-revenue').textContent = '฿' + formatNumber(data.totalRevenue || 0);
        document.getElementById('stat-expiring').textContent = data.expiringPolicies || 0;
        
      } catch (error) {
        console.error('Dashboard error:', error);
        showToast('ไม่สามารถโหลด Dashboard ได้', 'warning');
      }
    }
    
    async function loadServiceTypeStats() {
      if (!systemInitialized) return;
      
      try {
        const stats = await callGoogleScript('getServiceTypeStats');
        
        const statsDiv = document.getElementById('service-type-stats');
        if (statsDiv) {
          let statsHtml = '<div class="dashboard-grid">';
          
          Object.entries(stats).forEach(([sheetName, data]) => {
            const colorClass = getServiceTypeColorClass(sheetName);
            statsHtml += `
              <div class="stat-card ${colorClass}">
                <span class="material-icons" style="font-size: 36px;">${getServiceTypeIcon(sheetName)}</span>
                <h3>${data.count}</h3>
                <p>${sheetName}</p>
                <small>฿${formatNumber(data.totalAmount)}</small>
              </div>
            `;
          });
          
          statsHtml += '</div>';
          statsDiv.innerHTML = statsHtml;
        }
      } catch (error) {
        console.error('Error loading service type stats:', error);
      }
    }
    
    // ==================== CUSTOMER FUNCTIONS ====================
    async function loadCustomerList() {
      if (!systemInitialized) return;
      
      try {
        const response = await callGoogleScript('getCustomerListWrapped');
        
        if (response && response.success) {
          customers = response.data || [];
          updateCustomerTable(customers);
        } else {
          throw new Error(response?.message || 'Failed to load customers');
        }
      } catch (error) {
        console.error('Error loading customers:', error);
        showToast('ไม่สามารถโหลดข้อมูลลูกค้าได้', 'error');
        updateCustomerTable([]);
      }
    }
    
    function updateCustomerTable(customerData) {
      const tbody = document.getElementById('customer-tbody');
      if (!tbody) return;
      
      if (customerData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ยังไม่มีข้อมูลลูกค้า</td></tr>';
      } else {
        tbody.innerHTML = customerData.map(customer => `
          <tr>
            <td>${customer.id}</td>
            <td>${customer.name}</td>
            <td>${customer.phone || '-'}</td>
            <td>${customer.email || '-'}</td>
            <td><span class="badge ${customer.status === 'Active' ? 'badge-success' : 'badge-danger'}">${customer.status}</span></td>
            <td>
              <div class="table-actions">
                <button class="btn btn-sm btn-primary" onclick="editCustomer('${customer.id}')" title="แก้ไข">
                  <span class="material-icons">edit</span>
                </button>
                <button class="btn btn-sm btn-danger" onclick="confirmDelete('customer', '${customer.id}', '${customer.name}')" title="ลบ">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }
    }
    
    function openCustomerModal() {
      const modal = document.getElementById('customer-modal');
      const form = document.getElementById('customer-form');
      
      if (modal && form) {
        modal.style.display = 'block';
        form.reset();
        document.getElementById('customer-id').value = '';
      }
    }
    
    async function saveCustomer() {
      const nameField = document.getElementById('customer-name');
      if (!nameField || !nameField.value.trim()) {
        showToast('กรุณาใส่ชื่อลูกค้า', 'warning');
        return;
      }
      
      const data = {
        id: document.getElementById('customer-id').value,
        name: document.getElementById('customer-name').value.trim(),
        idCard: document.getElementById('customer-idcard').value.trim(),
        phone: document.getElementById('customer-phone').value.trim(),
        email: document.getElementById('customer-email').value.trim(),
        shippingAddress: document.getElementById('customer-shipping').value.trim(),
        documentAddress: document.getElementById('customer-document').value.trim(),
        notes: document.getElementById('customer-notes').value.trim(),
        status: 'Active'
      };
      
      try {
        showLoading('กำลังบันทึกข้อมูลลูกค้า...');
        
        const result = await callGoogleScript('saveCustomer', data);
        
        if (result && result.success) {
          showToast(result.message, 'success');
          closeModal('customer-modal');
          await loadCustomerList();
        } else {
          throw new Error(result?.message || 'Save failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error saving customer:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    function refreshCustomerList() {
      loadCustomerList();
    }
    
    // ==================== VEHICLE FUNCTIONS ====================
    async function loadVehicleList() {
      if (!systemInitialized) return;
      
      try {
        const response = await callGoogleScript('getVehicleListWrapped');
        
        if (response && response.success) {
          vehicles = response.data || [];
          updateVehicleTable(vehicles);
        } else {
          throw new Error(response?.message || 'Failed to load vehicles');
        }
      } catch (error) {
        console.error('Error loading vehicles:', error);
        showToast('ไม่สามารถโหลดข้อมูลรถได้', 'error');
        updateVehicleTable([]);
      }
    }
    
    function updateVehicleTable(vehicleData) {
      const tbody = document.getElementById('vehicle-tbody');
      if (!tbody) return;
      
      if (vehicleData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ยังไม่มีข้อมูลรถ</td></tr>';
      } else {
        tbody.innerHTML = vehicleData.map(vehicle => {
          const owner = customers.find(c => c.id === vehicle.customerId);
          return `
            <tr>
              <td>${vehicle.id}</td>
              <td>${vehicle.licensePlate}</td>
              <td>${vehicle.brand || '-'} ${vehicle.model || ''}</td>
              <td>${vehicle.color || '-'}</td>
              <td>${vehicle.year || '-'}</td>
              <td>${owner ? owner.name : '-'}</td>
              <td>
                <div class="table-actions">
                  <button class="btn btn-sm btn-primary" onclick="editVehicle('${vehicle.id}')" title="แก้ไข">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="confirmDelete('vehicle', '${vehicle.id}', '${vehicle.licensePlate}')" title="ลบ">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }
    }
    
    function openVehicleModal() {
      const modal = document.getElementById('vehicle-modal');
      const form = document.getElementById('vehicle-form');
      
      if (modal && form) {
        modal.style.display = 'block';
        form.reset();
        document.getElementById('vehicle-id').value = '';
        document.getElementById('vehicle-owner').value = '';
        document.getElementById('vehicle-owner-search').value = '';
      }
    }
    
    async function saveVehicle() {
      const ownerField = document.getElementById('vehicle-owner');
      const licenseField = document.getElementById('vehicle-license');
      
      if (!ownerField || !ownerField.value) {
        showToast('กรุณาเลือกเจ้าของรถ', 'warning');
        return;
      }
      
      if (!licenseField || !licenseField.value.trim()) {
        showToast('กรุณาใส่ทะเบียนรถ', 'warning');
        return;
      }
      
      const data = {
        id: document.getElementById('vehicle-id').value,
        customerId: document.getElementById('vehicle-owner').value,
        licensePlate: document.getElementById('vehicle-license').value.trim(),
        brand: document.getElementById('vehicle-brand').value.trim(),
        model: document.getElementById('vehicle-model').value.trim(),
        color: document.getElementById('vehicle-color').value.trim(),
        year: document.getElementById('vehicle-year').value.trim(),
        chassisNumber: document.getElementById('vehicle-chassis').value.trim()
      };
      
      try {
        showLoading('กำลังบันทึกข้อมูลรถ...');
        
        const result = await callGoogleScript('saveVehicle', data);
        
        if (result && result.success) {
          showToast(result.message, 'success');
          closeModal('vehicle-modal');
          await loadVehicleList();
        } else {
          throw new Error(result?.message || 'Save failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error saving vehicle:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    function refreshVehicleList() {
      loadVehicleList();
    }
    
    // ==================== PROPERTY FUNCTIONS ====================
    async function loadPropertyList() {
      if (!systemInitialized) return;
      
      try {
        const response = await callGoogleScript('getPropertyListWrapped');
        
        if (response && response.success) {
          properties = response.data || [];
          updatePropertyTable(properties);
        } else {
          throw new Error(response?.message || 'Failed to load properties');
        }
      } catch (error) {
        console.error('Error loading properties:', error);
        showToast('ไม่สามารถโหลดข้อมูลทรัพย์สินได้', 'error');
        updatePropertyTable([]);
      }
    }
    
    function updatePropertyTable(propertyData) {
      const tbody = document.getElementById('property-tbody');
      if (!tbody) return;
      
      if (propertyData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ยังไม่มีข้อมูลทรัพย์สิน</td></tr>';
      } else {
        tbody.innerHTML = propertyData.map(property => {
          const owner = customers.find(c => c.id === property.customerId);
          return `
            <tr>
              <td>${property.id}</td>
              <td>${property.type}</td>
              <td>${property.name}</td>
              <td>${property.address || '-'}</td>
              <td>${property.value ? '฿' + formatNumber(property.value) : '-'}</td>
              <td>${property.vehicleType || '-'}</td>
              <td>${property.vehicleCode || '-'}</td>
              <td>${owner ? owner.name : '-'}</td>
              <td>
                <div class="table-actions">
                  <button class="btn btn-sm btn-primary" onclick="editProperty('${property.id}')" title="แก้ไข">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="confirmDelete('property', '${property.id}', '${property.name}')" title="ลบ">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }
    }
    
    function openPropertyModal() {
      const modal = document.getElementById('property-modal');
      const form = document.getElementById('property-form');
      
      if (modal && form) {
        modal.style.display = 'block';
        form.reset();
        document.getElementById('property-id').value = '';
        document.getElementById('property-owner').value = '';
        document.getElementById('property-owner-search').value = '';
      }
    }
    
    async function saveProperty() {
      const ownerField = document.getElementById('property-owner');
      const typeField = document.getElementById('property-type');
      const nameField = document.getElementById('property-name');
      
      if (!ownerField || !ownerField.value) {
        showToast('กรุณาเลือกเจ้าของทรัพย์สิน', 'warning');
        return;
      }
      
      if (!typeField || !typeField.value) {
        showToast('กรุณาเลือกประเภททรัพย์สิน', 'warning');
        return;
      }
      
      if (!nameField || !nameField.value.trim()) {
        showToast('กรุณาใส่ชื่อทรัพย์สิน', 'warning');
        return;
      }
      
      const data = {
        id: document.getElementById('property-id').value,
        customerId: document.getElementById('property-owner').value,
        type: document.getElementById('property-type').value,
        name: document.getElementById('property-name').value.trim(),
        address: document.getElementById('property-address').value.trim(),
        value: document.getElementById('property-value').value,
        description: document.getElementById('property-description').value.trim(),
        vehicleType: document.getElementById('property-vehicle-type').value,
        vehicleCode: document.getElementById('property-vehicle-code').value.trim()
      };
      
      try {
        showLoading('กำลังบันทึกข้อมูลทรัพย์สิน...');
        
        const result = await callGoogleScript('saveProperty', data);
        
        if (result && result.success) {
          showToast(result.message, 'success');
          closeModal('property-modal');
          await loadPropertyList();
        } else {
          throw new Error(result?.message || 'Save failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error saving property:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    function refreshPropertyList() {
      loadPropertyList();
    }
    
    // ==================== WORK ORDER FUNCTIONS ====================
    function loadWorkOrderForm() {
      resetWorkOrderForm();
      getNextWorkOrderNumber();
    }
    
    async function getNextWorkOrderNumber() {
      if (!systemInitialized) return;
      
      try {
        const woNumber = await callGoogleScript('getNextWorkOrderId');
        const woNumberInput = document.getElementById('wo-number');
        if (woNumberInput) {
          woNumberInput.value = woNumber;
        }
      } catch (error) {
        console.error('Error getting work order number:', error);
      }
    }
    
    function resetWorkOrderForm() {
      const form = document.getElementById('workorder-form');
      if (form) form.reset();
      
      selectedCustomer = null;
      workOrderItems = [];
      
      // Clear edit mode
      const editWorkOrderId = document.getElementById('edit-workorder-id');
      if (editWorkOrderId) {
        editWorkOrderId.remove();
      }
      
      // Reset customer info
      const customerInfo = document.getElementById('selected-customer-info');
      if (customerInfo) {
        customerInfo.innerHTML = '<span class="text-muted">กรุณาเลือกลูกค้า</span>';
      }
      
      // Reset asset selection
      const assetType = document.getElementById('wo-asset-type');
      const asset = document.getElementById('wo-asset');
      
      if (assetType) assetType.value = '';
      if (asset) {
        asset.disabled = true;
        asset.innerHTML = '<option value="">-- เลือกทรัพย์สิน --</option>';
      }
      
      // Reset payment section
      const paymentType = document.getElementById('wo-payment-type');
      if (paymentType) paymentType.value = '';
      handlePaymentTypeChange(); // Reset payment fields visibility
      
      // Set current date
      const dateInput = document.getElementById('wo-date');
      if (dateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
      }
      
      // Set payment date to today
      const paymentDateInput = document.getElementById('wo-payment-date');
      if (paymentDateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        paymentDateInput.value = `${year}-${month}-${day}`;
      }
      
      // Get new work order number
      getNextWorkOrderNumber();
      
      // Add default item
      addWorkOrderItem();
    }
    
    async function loadWorkOrderList() {
      if (!systemInitialized) return;
      
      try {
        const data = await callGoogleScript('getWorkOrderList');
        workOrders = data || [];
        
        // Sort by created date (newest first) and limit
        const sortedWorkOrders = workOrders
          .sort((a, b) => {
            const dateA = new Date(a.createdDate || 0);
            const dateB = new Date(b.createdDate || 0);
            return dateB - dateA;
          })
          .slice(0, DISPLAY_LIMIT);
        
        updateWorkOrderTable(sortedWorkOrders);
      } catch (error) {
        console.error('Error loading work orders:', error);
        showToast('ไม่สามารถโหลดรายการใบงานได้', 'error');
        updateWorkOrderTable([]);
      }
    }
    
    // ==================== อัพเดต updateWorkOrderTable สำหรับปุ่มแจ้งงานและโคลน ====================
    function updateWorkOrderTable(workOrderData) {
      const tbody = document.getElementById('workorder-tbody');
      if (!tbody) return;
      
      if (!workOrderData || workOrderData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ยังไม่มีใบงาน</td></tr>';
      } else {
        tbody.innerHTML = workOrderData.map(wo => `
          <tr>
            <td>${wo.id}</td>
            <td>${formatDate(wo.createdDate)}</td>
            <td title="${wo.customerName}">${wo.customerName.length > 15 ? wo.customerName.substring(0, 15) + '...' : wo.customerName}</td>
            <td>฿${formatNumber(wo.premium)}</td>
            <td>
              <span class="badge ${getStatusBadgeClass(wo.status)}" style="font-size: 10px;">${wo.status}</span>
              ${wo.paymentStatus ? `<br><span class="badge ${getPaymentStatusBadgeClass(wo.paymentStatus)}" style="font-size: 10px;">${wo.paymentStatus}</span>` : ''}
            </td>
            <td>
              <div class="table-actions">
                <button class="btn btn-sm btn-primary" onclick="viewWorkOrderDetails('${wo.id}')" title="ดู">
                  <span class="material-icons">visibility</span>
                </button>
                <button class="btn btn-sm btn-warning" onclick="editWorkOrder('${wo.id}')" title="แก้ไข">
                  <span class="material-icons">edit</span>
                </button>
                <button class="btn btn-sm btn-success" onclick="cloneWorkOrder('${wo.id}')" title="โคลน">
                  <span class="material-icons">content_copy</span>
                </button>
                <button class="btn btn-sm btn-info" onclick="prepareEmailNotification('${wo.id}')" title="แจ้งงาน">
                  <span class="material-icons">email</span>
                </button>
                ${wo.paymentStatus !== 'ชำระเต็มจำนวน' ? `
                  <button class="btn btn-sm btn-secondary" onclick="openPaymentModal('${wo.id}')" title="ชำระเงิน">
                    <span class="material-icons">payment</span>
                  </button>
                ` : ''}
                ${wo.status !== 'ยกเลิก' ? `
                  <button class="btn btn-sm btn-danger" onclick="confirmCancel('${wo.id}')" title="ยกเลิก">
                    <span class="material-icons">cancel</span>
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `).join('');
      }
    }
    
    function addWorkOrderItem() {
      const itemId = Date.now();
      workOrderItems.push({
        id: itemId,
        serviceType: '',
        insuranceType: '',
        details: '',
        sumInsured: 0,
        premium: 0,
        startDate: '',
        endDate: '',
        policyNumber: '',
        insuranceCompany: ''
      });
      updateWorkOrderItemsTable();
    }
    
    function removeWorkOrderItem(index) {
      if (workOrderItems.length > 1) {
        workOrderItems.splice(index, 1);
        updateWorkOrderItemsTable();
      } else {
        showToast('ต้องมีอย่างน้อย 1 รายการ', 'warning');
      }
    }
    
    function updateWorkOrderItemsTable() {
      const tbody = document.getElementById('work-order-items');
      if (!tbody) return;
      
      tbody.innerHTML = workOrderItems.map((item, index) => {
        const isNonInsurance = ['พรบ', 'ภาษีรถ', 'ค่าตรวจสภาพรถ', 'ค่าบริการ', 'อื่นๆ'].includes(item.serviceType);
        const shouldDisableInsuranceFields = ['ภาษีรถ', 'ค่าตรวจสภาพรถ', 'ค่าบริการ', 'อื่นๆ'].includes(item.serviceType);
        
        return `
        <tr>
          <td>
            <select class="form-control" onchange="updateItemField(${index}, 'serviceType', this.value)">
              <option value="">-- เลือก --</option>
              <option value="ประกันภัย" ${item.serviceType === 'ประกันภัย' ? 'selected' : ''}>ประกันภัย</option>
              <option value="พรบ" ${item.serviceType === 'พรบ' ? 'selected' : ''}>พ.ร.บ.</option>
              <option value="ภาษีรถ" ${item.serviceType === 'ภาษีรถ' ? 'selected' : ''}>ภาษีรถ</option>
              <option value="ค่าตรวจสภาพรถ" ${item.serviceType === 'ค่าตรวจสภาพรถ' ? 'selected' : ''}>ค่าตรวจสภาพรถ</option>
              <option value="ค่าบริการ" ${item.serviceType === 'ค่าบริการ' ? 'selected' : ''}>ค่าบริการ</option>
              <option value="อื่นๆ" ${item.serviceType === 'อื่นๆ' ? 'selected' : ''}>อื่นๆ</option>
            </select>
          </td>
          <td>
            <select class="form-control" onchange="updateItemField(${index}, 'insuranceType', this.value)" ${isNonInsurance ? 'disabled' : ''}>
              <option value="">-- เลือก --</option>
              <option value="ประเภท 1" ${item.insuranceType === 'ประเภท 1' ? 'selected' : ''}>ประเภท 1</option>
              <option value="ประเภท 2" ${item.insuranceType === 'ประเภท 2' ? 'selected' : ''}>ประเภท 2</option>
              <option value="ประเภท 2+" ${item.insuranceType === 'ประเภท 2+' ? 'selected' : ''}>ประเภท 2+</option>
              <option value="ประเภท 3+" ${item.insuranceType === 'ประเภท 3+' ? 'selected' : ''}>ประเภท 3+</option>
              <option value="ประเภท 3" ${item.insuranceType === 'ประเภท 3' ? 'selected' : ''}>ประเภท 3</option>
              <option value="พรบ." ${item.insuranceType === 'พรบ.' ? 'selected' : ''}>พรบ.</option>
              <option value="ไม่เกี่ยวข้อง" ${item.insuranceType === 'ไม่เกี่ยวข้อง' ? 'selected' : ''}>ไม่เกี่ยวข้อง</option>
            </select>
          </td>
          <td>
            <input type="text" class="form-control" value="${item.details}" 
                   onchange="updateItemField(${index}, 'details', this.value)"
                   placeholder="รายละเอียด">
          </td>
          <td>
            <input type="number" class="form-control" value="${item.sumInsured}" 
                   onchange="updateItemField(${index}, 'sumInsured', this.value)"
                   min="0" step="0.01" placeholder="ทุนประกัน" ${isNonInsurance ? 'disabled' : ''}>
          </td>
          <td>
            <input type="number" class="form-control" value="${item.premium}" 
                   onchange="updateItemField(${index}, 'premium', this.value)"
                   min="0" step="0.01" placeholder="เบี้ยประกัน">
          </td>
          <td>
            <input type="date" class="form-control" value="${item.startDate}" 
                   onchange="updateItemField(${index}, 'startDate', this.value)">
          </td>
          <td>
            <input type="date" class="form-control" value="${item.endDate}" 
                   onchange="updateItemField(${index}, 'endDate', this.value)">
            <div class="auto-calculate">คำนวณ +1 ปี</div>
          </td>
          <td>
            <input type="text" class="form-control" value="${item.policyNumber}" 
                   onchange="updateItemField(${index}, 'policyNumber', this.value)"
                   placeholder="เลขกรมธรรม์" ${shouldDisableInsuranceFields ? 'disabled' : ''}>
          </td>
          <td>
            <select class="form-control" onchange="updateItemField(${index}, 'insuranceCompany', this.value)" ${shouldDisableInsuranceFields ? 'disabled' : ''}>
              <option value="">-- เลือก --</option>
              ${companies.filter(c => c.status === 'Active')
                .map(c => `<option value="${c.id}" ${item.insuranceCompany === c.id ? 'selected' : ''}>${c.name}</option>`)
                .join('')}
            </select>
          </td>
          <td>
            <button type="button" class="remove-item-btn" onclick="removeWorkOrderItem(${index})" title="ลบรายการ">
              <span class="material-icons">delete</span>
            </button>
          </td>
        </tr>
      `;
      }).join('');
      
      calculateTotals();
    }
    
    function updateItemField(index, field, value) {
      if (!workOrderItems[index]) return;
      
      if (field === 'sumInsured' || field === 'premium') {
        workOrderItems[index][field] = parseFloat(value) || 0;
      } else {
        workOrderItems[index][field] = value;
      }
      
      // Auto-set details based on service type
      if (field === 'serviceType' && value) {
        const assetSelect = document.getElementById('wo-asset');
        const assetText = assetSelect && assetSelect.selectedIndex > 0 ? 
          assetSelect.options[assetSelect.selectedIndex].text : '';
        
        if (value === 'ประกันภัย') {
          workOrderItems[index].details = `ประกันภัย ${assetText}`;
        } else if (value === 'พรบ') {
          workOrderItems[index].details = `พ.ร.บ. ${assetText}`;
          workOrderItems[index].insuranceType = 'พรบ.';
          workOrderItems[index].sumInsured = 0;
        } else if (value === 'ภาษีรถ') {
          workOrderItems[index].details = `ภาษีรถ ${assetText}`;
          workOrderItems[index].insuranceType = 'ไม่เกี่ยวข้อง';
          workOrderItems[index].sumInsured = 0;
          workOrderItems[index].policyNumber = '';
          workOrderItems[index].insuranceCompany = '';
        } else if (value === 'ค่าตรวจสภาพรถ') {
          workOrderItems[index].details = `ค่าตรวจสภาพรถ ${assetText}`;
          workOrderItems[index].insuranceType = 'ไม่เกี่ยวข้อง';
          workOrderItems[index].sumInsured = 0;
          workOrderItems[index].policyNumber = '';
          workOrderItems[index].insuranceCompany = '';
        } else if (value === 'ค่าบริการ' || value === 'อื่นๆ') {
          workOrderItems[index].details = value;
          workOrderItems[index].insuranceType = 'ไม่เกี่ยวข้อง';
          workOrderItems[index].sumInsured = 0;
          workOrderItems[index].policyNumber = '';
          workOrderItems[index].insuranceCompany = '';
        }
        updateWorkOrderItemsTable();
      }
      
      // Auto-calculate end date when start date changes
      if (field === 'startDate' && value) {
        const startDate = new Date(value);
        const endDate = new Date(startDate);
        endDate.setFullYear(endDate.getFullYear() + 1);
        workOrderItems[index].endDate = endDate.toISOString().split('T')[0];
        updateWorkOrderItemsTable();
      }
      
      calculateTotals();
    }
    
    function calculateTotals() {
      const totalPremium = workOrderItems.reduce((sum, item) => sum + (parseFloat(item.premium) || 0), 0);
      const totalElement = document.getElementById('total-premium');
      if (totalElement) totalElement.textContent = formatNumber(totalPremium);
      
      // Re-calculate balance after discount
      const discountInput = document.getElementById('discount-amount');
      const balanceElement   = document.getElementById('balance-premium');
      const discountValue = discountInput && discountInput.value ? parseFloat(discountInput.value) : 0;
      if (balanceElement) {
        const balance = Math.max(totalPremium - discountValue, 0);
        balanceElement.value = formatNumber(balance);
      }
    }
    
    async function saveWorkOrder() {
      if (!selectedCustomer) {
        showToast('กรุณาเลือกลูกค้า', 'warning');
        return;
      }
      
      const assetType = document.getElementById('wo-asset-type');
      if (!assetType || !assetType.value) {
        showToast('กรุณาเลือกประเภททรัพย์สิน', 'warning');
        return;
      }
      
      const paymentType = document.getElementById('wo-payment-type');
      if (!paymentType || !paymentType.value) {
        showToast('กรุณาเลือกประเภทการชำระเงิน', 'warning');
        return;
      }
      
      // Validate installments if payment type is installment
      const installments = document.getElementById('wo-installments');
      if (paymentType.value === 'ผ่อนชำระ' && (!installments || !installments.value)) {
        showToast('กรุณาเลือกจำนวนงวด', 'warning');
        return;
      }
      
      // Validate items
      const validItems = workOrderItems.filter(item => item.serviceType && item.premium > 0);
      if (validItems.length === 0) {
        showToast('กรุณาเพิ่มรายการอย่างน้อย 1 รายการ', 'warning');
        return;
      }
      
      // Find earliest start date and latest end date
      const startDates = validItems.map(item => item.startDate).filter(date => date);
      const endDates = validItems.map(item => item.endDate).filter(date => date);
      
      // Check if editing
      const editWorkOrderId = document.getElementById('edit-workorder-id');
      const isEditing = editWorkOrderId && editWorkOrderId.value;
      
      // Get work order number
      const woNumberInput = document.getElementById('wo-number');
      const workOrderNumber = woNumberInput ? woNumberInput.value : null;
      
      const discountInput = document.getElementById('discount-amount');
      const discountValue = discountInput && discountInput.value ? parseFloat(discountInput.value) : 0;
      const balanceAmount = validItems.reduce((sum, item) => sum + item.premium, 0) - discountValue;
      
      const data = {
        id: isEditing ? editWorkOrderId.value : null,
        workOrderNumber: isEditing ? null : workOrderNumber,
        customerId: selectedCustomer.id,
        customerName: selectedCustomer.name,
        vehicleId: assetType.value === 'vehicle' ? (document.getElementById('wo-asset')?.value || '') : '',
        propertyId: assetType.value === 'property' ? (document.getElementById('wo-asset')?.value || '') : '',
        items: validItems,
        startDate: startDates.length > 0 ? startDates.sort()[0] : '',
        endDate: endDates.length > 0 ? endDates.sort().reverse()[0] : '',
        status: isEditing ? undefined : 'แจ้งงานแล้ว',
        // Payment information
        paymentType: paymentType.value,
        numberOfInstallments: paymentType.value === 'ผ่อนชำระ' ? installments.value : null,
        installmentPlan: paymentType.value === 'ผ่อนชำระ' ? installmentPlanData : null,
        paymentStartDate: document.getElementById('wo-payment-date')?.value || new Date(),
        discount: discountValue,
        balanceAmount: balanceAmount,
        paymentStatus: paymentType.value === 'ผ่อนชำระ' ? 'อยู่ระหว่างชำระผ่อน' : 'ชำระเต็มจำนวน'
      };
      
      try {
        showLoading(isEditing ? 'กำลังอัพเดตใบงาน...' : 'กำลังบันทึกใบงาน...');
        
        const result = await callGoogleScript('saveWorkOrder', data);
        
        if (result && result.success) {
          // Save payment information if not editing and payment type is not installment
          if (!isEditing && paymentType.value !== 'ผ่อนชำระ') {
            const paymentData = {
              workOrderId: result.workOrderId,
              amount: validItems.reduce((sum, item) => sum + item.premium, 0),
              paymentType: paymentType.value,
              referenceNumber: document.getElementById('wo-payment-reference')?.value || '',
              bank: document.getElementById('wo-bank')?.value || '',
              notes: document.getElementById('wo-payment-notes')?.value || ''
            };
            
            // Save payment record
            await callGoogleScript('savePayment', paymentData);
          }
          
          showToast(result.message, 'success');
          
          // Clear edit mode
          if (editWorkOrderId) {
            editWorkOrderId.remove();
          }
          
          resetWorkOrderForm();
          await refreshWorkOrderList();
          await loadServiceTypeStats();
        } else {
          throw new Error(result?.message || 'Save failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error saving work order:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    async function searchWorkOrders() {
      const searchInput = document.getElementById('search-workorder');
      if (!searchInput) return;
      
      const searchText = searchInput.value.trim();
      if (!searchText) {
        showToast('กรุณาใส่คำค้นหา', 'warning');
        return;
      }
      
      if (!systemInitialized) {
        showToast('ระบบยังไม่พร้อม', 'warning');
        return;
      }
      
      try {
        showLoading('กำลังค้นหา...');
        
        // First search in work orders
        const woResult = await callGoogleScript('searchWorkOrders', searchText);
        let allResults = [];
        
        if (woResult && woResult.success && woResult.data) {
          allResults = [...woResult.data];
        }
        
        // Also search by customer name
        const customerResult = await callGoogleScript('searchCustomers', searchText);
        if (customerResult && customerResult.success && customerResult.data) {
          for (const customer of customerResult.data) {
            const customerWorkOrders = workOrders.filter(wo => wo.customerId === customer.id);
            allResults.push(...customerWorkOrders);
          }
        }
        
        // Search by license plate in vehicles
        const vehicleResult = await callGoogleScript('searchVehicles', searchText);
        if (vehicleResult && vehicleResult.success && vehicleResult.data) {
          for (const vehicle of vehicleResult.data) {
            const vehicleWorkOrders = workOrders.filter(wo => wo.propertyId === vehicle.id);
            allResults.push(...vehicleWorkOrders);
          }
        }
        
        // Remove duplicates
        const uniqueResults = Array.from(new Map(allResults.map(item => [item.id, item])).values());
        
        if (uniqueResults.length === 0) {
          showToast('ไม่พบใบงานที่ค้นหา', 'info');
          updateWorkOrderTable([]);
        } else {
          showToast(`พบ ${uniqueResults.length} รายการ`, 'success');
          const displayData = uniqueResults.slice(0, DISPLAY_LIMIT);
          updateWorkOrderTable(displayData);
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error searching work orders:', error);
        showToast(`เกิดข้อผิดพลาดในการค้นหา: ${error.message}`, 'error');
      }
    }
    
    function clearWorkOrderSearch() {
      const searchInput = document.getElementById('search-workorder');
      if (searchInput) {
        searchInput.value = '';
      }
      refreshWorkOrderList();
    }
    
    function refreshWorkOrderList() {
      loadWorkOrderList();
    }
    
    async function loadAssets() {
      const assetType = document.getElementById('wo-asset-type');
      const assetSelect = document.getElementById('wo-asset');
      
      if (!assetType || !assetSelect || !selectedCustomer) {
        if (assetSelect) {
          assetSelect.disabled = true;
          assetSelect.innerHTML = '<option value="">-- เลือกทรัพย์สิน --</option>';
        }
        return;
      }
      
      const assetTypeValue = assetType.value;
      
      if (!assetTypeValue) {
        assetSelect.disabled = true;
        assetSelect.innerHTML = '<option value="">-- เลือกทรัพย์สิน --</option>';
        return;
      }
      
      assetSelect.disabled = false;
      
      if (assetTypeValue === 'vehicle') {
        if (vehicles.length === 0) {
          await loadVehicleList();
        }
        
        assetSelect.innerHTML = '<option value="">-- เลือกรถ --</option>' +
          vehicles.filter(v => v.customerId === selectedCustomer.id)
            .map(v => `<option value="${v.id}">${v.licensePlate} - ${v.brand || ''} ${v.model || ''}</option>`)
            .join('');
      } else {
        if (properties.length === 0) {
          await loadPropertyList();
        }
        
        assetSelect.innerHTML = '<option value="">-- เลือกทรัพย์สิน --</option>' +
          properties.filter(p => p.customerId === selectedCustomer.id)
            .map(p => `<option value="${p.id}">${p.name} - ${p.type}</option>`)
            .join('');
      }
    }
    
    // ==================== CUSTOMER AUTOCOMPLETE ====================
    function setupCustomerAutocomplete() {
      const searchInput = document.getElementById('wo-customer-search');
      const dropdown = document.getElementById('customer-autocomplete');
      
      if (!searchInput || !dropdown) return;
      
      let selectedIndex = -1;
      
      searchInput.addEventListener('input', async function() {
        const searchText = this.value.trim();
        
        if (searchText.length < 2) {
          dropdown.classList.remove('show');
          return;
        }
        
        if (!systemInitialized) return;
        
        try {
          const result = await callGoogleScript('searchCustomersForAutocomplete', searchText);
          
          if (result && result.success && result.data.length > 0) {
            displayAutocompleteResults(result.data);
          } else {
            dropdown.classList.remove('show');
          }
        } catch (error) {
          console.error('Autocomplete error:', error);
          dropdown.classList.remove('show');
        }
      });
      
      // Keyboard navigation
      searchInput.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateAutocompleteSelection(items, selectedIndex);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, 0);
          updateAutocompleteSelection(items, selectedIndex);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].click();
          }
        } else if (e.key === 'Escape') {
          dropdown.classList.remove('show');
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });
    }
    
    function displayAutocompleteResults(results) {
      const dropdown = document.getElementById('customer-autocomplete');
      if (!dropdown) return;
      
      dropdown.innerHTML = results.map((customer, index) => `
        <div class="autocomplete-item" data-index="${index}" onclick="selectCustomer('${customer.id}')">
          <strong>${customer.name}</strong><br>
          <small>${customer.phone} ${customer.idCard ? '| ' + customer.idCard : ''}</small>
        </div>
      `).join('');
      
      dropdown.classList.add('show');
    }
    
    function updateAutocompleteSelection(items, index) {
      items.forEach((item, i) => {
        if (i === index) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }
    
    function selectCustomer(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        setSelectedCustomer(customer);
      } else {
        // Search for customer if not in current list
        callGoogleScript('searchCustomersForAutocomplete', customerId)
          .then(response => {
            if (response && response.success && response.data.length > 0) {
              const searchedCustomer = response.data.find(c => c.id === customerId);
              if (searchedCustomer) {
                setSelectedCustomer(searchedCustomer);
              }
            }
          })
          .catch(error => {
            console.error('Error searching customer:', error);
          });
      }
    }
    
    function setSelectedCustomer(customer) {
      selectedCustomer = customer;
      
      const searchInput = document.getElementById('wo-customer-search');
      const dropdown = document.getElementById('customer-autocomplete');
      const customerInfo = document.getElementById('selected-customer-info');
      const assetType = document.getElementById('wo-asset-type');
      
      if (searchInput) searchInput.value = customer.name;
      if (dropdown) dropdown.classList.remove('show');
      
      if (customerInfo) {
        customerInfo.innerHTML = `
          <strong>${customer.name}</strong><br>
          <small>โทร: ${customer.phone || '-'} | บัตรประชาชน: ${customer.idCard || '-'}</small>
        `;
      }
      
      if (assetType) assetType.disabled = false;
    }
    
    // ==================== OWNER SEARCH MODALS ====================
    function openOwnerSearchModal(type) {
      const modalId = type + '-owner-modal';
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'block';
        const searchInput = document.getElementById(type + '-owner-search-input');
        if (searchInput) {
          searchInput.value = '';
          searchInput.focus();
        }
        searchOwnersInModal(type, '');
      }
    }
    
    async function searchOwnersInModal(type, searchText) {
      const resultsDiv = document.getElementById(type + '-owner-results');
      if (!resultsDiv) return;
      
      if (!searchText || searchText.length < 2) {
        if (customers.length === 0) {
          resultsDiv.innerHTML = '<p class="text-center text-muted">ไม่พบข้อมูลลูกค้า</p>';
        } else {
          const displayCustomers = customers.slice(0, 20);
          displayOwnersInModal(displayCustomers, type);
        }
        return;
      }
      
      if (!systemInitialized) return;
      
      try {
        resultsDiv.innerHTML = '<p class="text-center">กำลังค้นหา...</p>';
        
        const result = await callGoogleScript('searchCustomersForAutocomplete', searchText);
        
        if (result && result.success && result.data.length > 0) {
          displayOwnersInModal(result.data, type);
        } else {
          resultsDiv.innerHTML = '<p class="text-center text-muted">ไม่พบลูกค้าที่ค้นหา</p>';
        }
      } catch (error) {
        console.error('Owner search error:', error);
        resultsDiv.innerHTML = '<p class="text-center text-danger">เกิดข้อผิดพลาดในการค้นหา</p>';
      }
    }
    
    function displayOwnersInModal(customerList, type) {
      const resultsDiv = document.getElementById(type + '-owner-results');
      if (!resultsDiv) return;
      
      resultsDiv.innerHTML = customerList.map(customer => `
        <div class="customer-result-item" onclick="selectOwnerFromModal('${customer.id}', '${customer.name}', '${type}')">
          <strong>${customer.name}</strong><br>
          <small>โทร: ${customer.phone || '-'} | บัตรประชาชน: ${customer.idCard || '-'}</small>
        </div>
      `).join('');
    }
    
    function selectOwnerFromModal(customerId, customerName, type) {
      const searchInput = document.getElementById(type + '-owner-search');
      const hiddenInput = document.getElementById(type + '-owner');
      const modalId = type + '-owner-modal';
      const modal = document.getElementById(modalId);
      
      if (searchInput) searchInput.value = customerName;
      if (hiddenInput) hiddenInput.value = customerId;
      if (modal) modal.style.display = 'none';
    }
    
    // ==================== EDIT FUNCTIONS ====================
    function editCustomer(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;
      
      document.getElementById('customer-id').value = customer.id;
      document.getElementById('customer-name').value = customer.name;
      document.getElementById('customer-idcard').value = customer.idCard || '';
      document.getElementById('customer-phone').value = customer.phone || '';
      document.getElementById('customer-email').value = customer.email || '';
      document.getElementById('customer-shipping').value = customer.shippingAddress || '';
      document.getElementById('customer-document').value = customer.documentAddress || '';
      document.getElementById('customer-notes').value = customer.notes || '';
      
      const modal = document.getElementById('customer-modal');
      if (modal) modal.style.display = 'block';
    }
    
    function editVehicle(vehicleId) {
      const vehicle = vehicles.find(v => v.id === vehicleId);
      if (!vehicle) return;
      
      const owner = customers.find(c => c.id === vehicle.customerId);
      
      document.getElementById('vehicle-id').value = vehicle.id;
      document.getElementById('vehicle-owner').value = vehicle.customerId;
      document.getElementById('vehicle-owner-search').value = owner ? owner.name : '';
      document.getElementById('vehicle-license').value = vehicle.licensePlate;
      document.getElementById('vehicle-brand').value = vehicle.brand || '';
      document.getElementById('vehicle-model').value = vehicle.model || '';
      document.getElementById('vehicle-color').value = vehicle.color || '';
      document.getElementById('vehicle-year').value = vehicle.year || '';
      document.getElementById('vehicle-chassis').value = vehicle.chassisNumber || '';
      
      const modal = document.getElementById('vehicle-modal');
      if (modal) modal.style.display = 'block';
    }
    
    function editProperty(propertyId) {
      const property = properties.find(p => p.id === propertyId);
      if (!property) return;
      
      const owner = customers.find(c => c.id === property.customerId);
      
      document.getElementById('property-id').value = property.id;
      document.getElementById('property-owner').value = property.customerId;
      document.getElementById('property-owner-search').value = owner ? owner.name : '';
      document.getElementById('property-type').value = property.type;
      document.getElementById('property-name').value = property.name;
      document.getElementById('property-address').value = property.address || '';
      document.getElementById('property-value').value = property.value || '';
      document.getElementById('property-description').value = property.description || '';
      document.getElementById('property-vehicle-type').value = property.vehicleType || '';
      document.getElementById('property-vehicle-code').value = property.vehicleCode || '';
      
      const modal = document.getElementById('property-modal');
      if (modal) modal.style.display = 'block';
    }
    
    async function editWorkOrder(workOrderId) {
      console.log('Editing work order:', workOrderId);
      
      let workOrder = workOrders.find(wo => wo.id === workOrderId);
      
      if (!workOrder) {
        try {
          const searchResult = await callGoogleScript('searchWorkOrders', workOrderId);
          if (searchResult && searchResult.success && searchResult.data.length > 0) {
            workOrder = searchResult.data.find(wo => wo.id === workOrderId);
          }
        } catch (error) {
          console.error('Error searching for work order:', error);
        }
      }
      
      if (!workOrder) {
        showToast('ไม่พบใบงานที่ต้องการแก้ไข', 'error');
        return;
      }
      
      try {
        showLoading('กำลังโหลดข้อมูล...');
        
        // Set work order number
        const woNumberInput = document.getElementById('wo-number');
        if (woNumberInput) {
          woNumberInput.value = workOrderId;
        }
        
        // Set work order date
        const woDateInput = document.getElementById('wo-date');
        if (woDateInput && workOrder.createdDate) {
          const dateStr = workOrder.createdDate.split('T')[0];
          woDateInput.value = dateStr;
        }
        
        // Load work order items
        const itemsResult = await callGoogleScript('getWorkOrderItems', workOrderId);
        const items = Array.isArray(itemsResult) ? itemsResult : [];
        
        // Set customer
        const customer = customers.find(c => c.id === workOrder.customerId);
        if (customer) {
          setSelectedCustomer(customer);
        } else {
          try {
            const customerResult = await callGoogleScript('searchCustomersForAutocomplete', workOrder.customerId);
            if (customerResult && customerResult.success && customerResult.data.length > 0) {
              const foundCustomer = customerResult.data[0];
              setSelectedCustomer(foundCustomer);
            }
          } catch (error) {
            console.error('Error loading customer:', error);
          }
        }
        
        // Set asset type and load assets
        if (workOrder.propertyId) {
          const assetType = document.getElementById('wo-asset-type');
          if (assetType) {
            assetType.value = workOrder.propertyId.startsWith('VEH') ? 'vehicle' : 'property';
            await loadAssets();
            
            const assetSelect = document.getElementById('wo-asset');
            if (assetSelect) {
              assetSelect.value = workOrder.propertyId;
            }
          }
        }
        
        // Load items
        if (items.length > 0) {
          workOrderItems = items.map(item => ({
            id: Date.now() + Math.random(),
            serviceType: item.serviceType || '',
            insuranceType: item.insuranceType || '',
            details: item.details || '',
            sumInsured: parseFloat(item.sumInsured) || 0,
            premium: parseFloat(item.premium) || 0,
            startDate: item.startDate || '',
            endDate: item.endDate || '',
            policyNumber: item.policyNumber || '',
            insuranceCompany: item.insuranceCompany || ''
          }));
        } else {
          workOrderItems = [{
            id: Date.now(),
            serviceType: 'ประกันภัย',
            insuranceType: workOrder.insuranceType || '',
            details: workOrder.details || '',
            sumInsured: workOrder.sumInsured || 0,
            premium: workOrder.premium || 0,
            startDate: workOrder.startDate || '',
            endDate: workOrder.endDate || '',
            policyNumber: workOrder.policyNumber || '',
            insuranceCompany: workOrder.insuranceCompany || ''
          }];
        }
        
        updateWorkOrderItemsTable();
        
        // Add work order ID to form for updating
        const form = document.getElementById('workorder-form');
        if (form) {
          let hiddenInput = document.getElementById('edit-workorder-id');
          if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'edit-workorder-id';
            form.appendChild(hiddenInput);
          }
          hiddenInput.value = workOrderId;
        }
        
        // Scroll to form
        const workorderForm = document.getElementById('workorder-form');
        if (workorderForm) {
          workorderForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        hideLoading();
        showToast('โหลดข้อมูลสำเร็จ กรุณาแก้ไขและบันทึก', 'info');
        
      } catch (error) {
        hideLoading();
        console.error('Error loading work order for edit:', error);
        showToast(`ไม่สามารถโหลดข้อมูลใบงานได้: ${error.message}`, 'error');
      }
    }
    
    // ==================== CLONE WORK ORDER FUNCTION ====================
    async function cloneWorkOrder(workOrderId) {
      try {
        showLoading('กำลังโคลนใบงาน...');
        
        const result = await callGoogleScript('cloneWorkOrder', workOrderId);
        
        if (result && result.success) {
          showToast('โคลนใบงานสำเร็จ', 'success');
          
          // Switch to work order page and edit the cloned work order
          showPage('workorder');
          
          // Wait a bit for the page to load
          setTimeout(() => {
            editWorkOrder(result.workOrderId);
          }, 500);
        } else {
          throw new Error(result?.message || 'Clone failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error cloning work order:', error);
        showToast(`ไม่สามารถโคลนใบงานได้: ${error.message}`, 'error');
      }
    }
    
    async function viewWorkOrderDetails(workOrderId) {
      try {
        showLoading('กำลังโหลดรายละเอียด...');
        
        const itemsResult = await callGoogleScript('getWorkOrderItems', workOrderId);
        const items = Array.isArray(itemsResult) ? itemsResult : [];
        
        hideLoading();
        displayWorkOrderItems(workOrderId, items);
      } catch (error) {
        hideLoading();
        console.error('Error loading work order details:', error);
        showToast(`ไม่สามารถโหลดรายละเอียดใบงานได้: ${error.message}`, 'error');
      }
    }
    
    function displayWorkOrderItems(workOrderId, items) {
      let workOrder = workOrders.find(wo => wo.id === workOrderId);
      
      if (!workOrder) {
        if (items && items.length > 0) {
          workOrder = {
            id: workOrderId,
            customerName: 'ไม่ทราบชื่อลูกค้า'
          };
        } else {
          showToast('ไม่พบข้อมูลใบงาน', 'error');
          return;
        }
      }
      
      let itemsHtml = `
        <h4>ใบงาน: ${workOrderId}</h4>
        <p><strong>ลูกค้า:</strong> ${workOrder.customerName}</p>
        <div class="btn-group mb-3">
          <button class="btn btn-primary btn-sm" onclick="printWorkOrder('${workOrderId}')">
            <span class="material-icons">print</span>
            พิมพ์ใบงาน
          </button>
        </div>
      `;
      
      if (!items || items.length === 0) {
        itemsHtml += `
          <div class="error-state">
            <p class="text-muted">ไม่พบรายการในใบงานนี้</p>
          </div>
        `;
      } else {
        // Group items by service type
        const itemsByType = {};
        items.forEach(item => {
          const type = item.serviceType || 'อื่นๆ';
          if (!itemsByType[type]) {
            itemsByType[type] = [];
          }
          itemsByType[type].push(item);
        });
        
        // Display grouped items
        Object.entries(itemsByType).forEach(([serviceType, typeItems]) => {
          const sheetName = SERVICE_SHEET_MAPPING[serviceType] || 'อื่นๆ';
          itemsHtml += `
            <div class="service-type-info mt-3">
              <span class="material-icons">${getServiceTypeIcon(sheetName)}</span>
              <span>${serviceType} (บันทึกในชีท: ${sheetName})</span>
            </div>
          `;
          
          itemsHtml += `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>รายละเอียด</th>
                    <th>ประเภทประกัน</th>
                    <th>ทุนประกัน</th>
                    <th>เบี้ยประกัน</th>
                    <th>วันเริ่ม</th>
                    <th>วันสิ้นสุด</th>
                    <th>เลขกรมธรรม์</th>
                    <th>บริษัทประกัน</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          typeItems.forEach(item => {
            const company = companies.find(c => c.id === item.insuranceCompany);
            itemsHtml += `
              <tr>
                <td>${item.details || '-'}</td>
                <td>${item.insuranceType || '-'}</td>
                <td>฿${formatNumber(item.sumInsured)}</td>
                <td>฿${formatNumber(item.premium)}</td>
                <td>${item.startDate ? formatDate(item.startDate) : '-'}</td>
                <td>${item.endDate ? formatDate(item.endDate) : '-'}</td>
                <td>${item.policyNumber || '-'}</td>
                <td>${company ? company.name : '-'}</td>
              </tr>
            `;
          });
          
          itemsHtml += `
                </tbody>
              </table>
            </div>
          `;
        });
        
        // Total summary
        const totalPremium = items.reduce((sum, item) => sum + (parseFloat(item.premium) || 0), 0);
        const totalSumInsured = items.reduce((sum, item) => sum + (parseFloat(item.sumInsured) || 0), 0);
        
        itemsHtml += `
          <div class="card mt-3">
            <div class="card-header">
              <h4>สรุปยอดรวม</h4>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>จำนวนรายการ:</label>
                <p><strong>${items.length} รายการ</strong></p>
              </div>
              <div class="form-group">
                <label>ทุนประกันรวม:</label>
                <p><strong>฿${formatNumber(totalSumInsured)}</strong></p>
              </div>
              <div class="form-group">
                <label>เบี้ยประกันรวม:</label>
                <p><strong>฿${formatNumber(totalPremium)}</strong></p>
              </div>
            </div>
            <div class="mt-3">
              <button class="btn btn-info btn-sm" onclick="viewPaymentHistory('${workOrderId}')">
                <span class="material-icons">history</span>
                ดูประวัติการชำระเงิน
              </button>
            </div>
          </div>
        `;
      }
      
      // Use search results modal to display details
      const modal = document.getElementById('search-results-modal');
      const content = document.getElementById('search-results-content');
      
      if (modal && content) {
        content.innerHTML = itemsHtml;
        modal.style.display = 'block';
      }
    }
    
    function confirmCancel(workOrderId) {
      const confirmButton = document.getElementById('confirm-button');
      if (confirmButton) {
        confirmButton.onclick = function() {
          cancelWorkOrder(workOrderId);
          closeModal('confirm-modal');
        };
      }
      
      document.getElementById('confirm-title').textContent = 'ยืนยันการยกเลิกใบงาน';
      document.getElementById('confirm-message').textContent = 'คุณแน่ใจหรือไม่ที่จะยกเลิกใบงานนี้?';
      
      const modal = document.getElementById('confirm-modal');
      if (modal) modal.style.display = 'block';
    }
    
    async function cancelWorkOrder(workOrderId) {
      try {
        showLoading('กำลังยกเลิกใบงาน...');
        
        const result = await callGoogleScript('cancelWorkOrder', workOrderId);
        
        if (result && result.success) {
          showToast(result.message, 'success');
          await refreshWorkOrderList();
        } else {
          throw new Error(result?.message || 'Cancel failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error cancelling work order:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    // ==================== DELETE FUNCTIONS ====================
    function confirmDelete(type, id, name) {
      const confirmButton = document.getElementById('confirm-button');
      if (confirmButton) {
        confirmButton.onclick = function() {
          switch(type) {
            case 'customer':
              deleteCustomer(id);
              break;
            case 'vehicle':
              deleteVehicle(id);
              break;
            case 'property':
              deleteProperty(id);
              break;
          }
          closeModal('confirm-modal');
        };
      }
      
      document.getElementById('confirm-title').textContent = 'ยืนยันการลบข้อมูล';
      document.getElementById('confirm-message').textContent = `คุณแน่ใจหรือไม่ที่จะลบ ${name}?`;
      
      const modal = document.getElementById('confirm-modal');
      if (modal) modal.style.display = 'block';
    }
    
    async function deleteCustomer(customerId) {
      try {
        showLoading('กำลังลบข้อมูลลูกค้า...');
        
        const result = await callGoogleScript('deleteCustomer', customerId);
        
        if (result && result.success) {
          showToast(result.message, 'success');
          await loadCustomerList();
        } else {
          throw new Error(result?.message || 'Delete failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error deleting customer:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    async function deleteVehicle(vehicleId) {
      try {
        showLoading('กำลังลบข้อมูลรถ...');
        
        const result = await callGoogleScript('deleteVehicle', vehicleId);
        
        if (result && result.success) {
          showToast(result.message, 'success');
          await loadVehicleList();
        } else {
          throw new Error(result?.message || 'Delete failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error deleting vehicle:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    async function deleteProperty(propertyId) {
      try {
        showLoading('กำลังลบข้อมูลทรัพย์สิน...');
        
        const result = await callGoogleScript('deleteProperty', propertyId);
        
        if (result && result.success) {
          showToast(result.message, 'success');
          await loadPropertyList();
        } else {
          throw new Error(result?.message || 'Delete failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error deleting property:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    // ==================== HISTORY FUNCTIONS ====================
    async function loadHistory() {
      if (!systemInitialized) return;
      
      try {
        showLoading('กำลังโหลดประวัติ...');
        
        const data = await callGoogleScript('getHistory', 50);
        
        history = data;
        displayHistory();
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error loading history:', error);
        showToast('ไม่สามารถโหลดประวัติได้', 'error');
      }
    }
    
    function displayHistory() {
      const timeline = document.getElementById('history-timeline');
      if (!timeline) return;
      
      if (history.length === 0) {
        timeline.innerHTML = '<p class="text-center text-muted">ยังไม่มีประวัติการทำงาน</p>';
      } else {
        timeline.innerHTML = history.map(item => `
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-date">${formatDateTime(item.date)}</div>
              <div><strong>${item.action}</strong></div>
              <div>${item.details}</div>
              <div class="text-muted" style="font-size: 14px;">
                โดย: ${item.user} | ${item.relatedTable} ${item.referenceId}
              </div>
            </div>
          </div>
        `).join('');
      }
    }
    
    // ==================== SETTINGS FUNCTIONS ====================
    async function saveSettings() {
      // Save employee email to localStorage
      const employeeEmail = document.getElementById('employee-email')?.value.trim();
      if (employeeEmail) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(employeeEmail)) {
          localStorage.setItem('employeeEmail', employeeEmail);
          window.EMPLOYEE_EMAIL = employeeEmail;
          showToast('บันทึกอีเมลพนักงานสำเร็จ', 'success');
        } else {
          showToast('รูปแบบอีเมลพนักงานไม่ถูกต้อง', 'warning');
          return;
        }
      }
      
      showToast('บันทึกการตั้งค่าสำเร็จ', 'success');
    }
    
    async function createBackup() {
      if (!confirm('ต้องการสำรองข้อมูลหรือไม่?')) {
        return;
      }
      
      if (!systemInitialized) {
        showToast('ระบบยังไม่พร้อม', 'warning');
        return;
      }
      
      try {
        showLoading('กำลังสร้างสำเนาสำรอง...');
        
        const result = await callGoogleScript('createBackup');
        
        if (result && result.success) {
          showToast(result.message, 'success');
          window.open(result.backupUrl, '_blank');
        } else {
          throw new Error(result?.message || 'Backup failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error creating backup:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    // ==================== COMPANY FUNCTIONS ====================
    async function loadCompanies() {
      if (!systemInitialized) return;
      
      try {
        const response = await callGoogleScript('getCompanyListWrapped');
        
        if (response && response.success) {
          companies = response.data || [];
          // เพิ่มอีเมลทดสอบสำหรับบริษัทที่ยังไม่มีอีเมล
          companies = companies.map(company => {
            if (!company.email) {
              // สร้างอีเมลตัวอย่างจากชื่อบริษัท
              const emailName = company.name.toLowerCase()
                .replace(/บริษัท|จำกัด|\(มหาชน\)|\s+/g, '')
                .substring(0, 20);
              company.email = `${emailName}@example.com`;
            }
            return company;
          });
          updateCompanySelects();
        } else {
          console.warn('Failed to load companies:', response);
        }
      } catch (error) {
        console.error('Error loading companies:', error);
      }
    }
    
    function updateCompanySelects() {
      // Companies are loaded in updateWorkOrderItemsTable
    }
    
    // ==================== EMAIL NOTIFICATION FUNCTIONS ====================
    async function prepareEmailNotification(workOrderId) {
      try {
        showLoading('กำลังเตรียมข้อมูลสำหรับส่งอีเมล...');
        
        // Get work order details
        let workOrder = workOrders.find(wo => wo.id === workOrderId);
        
        if (!workOrder) {
          const searchResult = await callGoogleScript('searchWorkOrders', workOrderId);
          if (searchResult && searchResult.success && searchResult.data.length > 0) {
            workOrder = searchResult.data.find(wo => wo.id === workOrderId);
          }
        }
        
        if (!workOrder) {
          hideLoading();
          showToast('ไม่พบข้อมูลใบงาน', 'error');
          return;
        }
        
        // Get customer details
        const customer = customers.find(c => c.id === workOrder.customerId);
        if (!customer) {
          hideLoading();
          showToast('ไม่พบข้อมูลลูกค้า', 'error');
          return;
        }
        
        // Get work order items
        const items = await callGoogleScript('getWorkOrderItems', workOrderId);
        
        // Get asset details (vehicle or property)
        let assetDetails = null;
        let chassisNumber = '';
        if (workOrder.propertyId) {
          if (workOrder.propertyId.startsWith('VEH')) {
            const vehicle = vehicles.find(v => v.id === workOrder.propertyId);
            if (vehicle) {
              assetDetails = {
                type: 'vehicle',
                data: vehicle
              };
              chassisNumber = vehicle.chassisNumber || '';
            }
          } else {
            const property = properties.find(p => p.id === workOrder.propertyId);
            if (property) {
              assetDetails = {
                type: 'property',
                data: property
              };
            }
          }
        }
        
        hideLoading();
        
        // Show email modal
        showEmailModal({
          workOrder: workOrder,
          customer: customer,
          items: items,
          assetDetails: assetDetails,
          chassisNumber: chassisNumber
        });
        
      } catch (error) {
        hideLoading();
        console.error('Error preparing email:', error);
        showToast('เกิดข้อผิดพลาดในการเตรียมข้อมูล', 'error');
      }
    }
    
    function showEmailModal(data) {
      const { workOrder, customer, items, assetDetails, chassisNumber } = data;
      
      // Get license plate from asset details
      let licensePlate = '';
      if (assetDetails && assetDetails.type === 'vehicle' && assetDetails.data) {
        licensePlate = assetDetails.data.licensePlate || '';
      }
      
      // Create email content
      let emailContent = `
=== ข้อมูลลูกค้า ===
ชื่อ: ${customer.name}
ที่อยู่ตามเอกสาร: ${customer.documentAddress || '-'}
เลขบัตรประชาชน: ${customer.idCard || '-'}
เบอร์โทร: ${customer.phone || '-'}
`;

      // Add asset details
      if (assetDetails && assetDetails.type === 'vehicle') {
        const vehicle = assetDetails.data;
        emailContent += `
=== ข้อมูลรถ ===
ทะเบียนรถ: ${vehicle.licensePlate}
ยี่ห้อ: ${vehicle.brand || '-'}
รุ่น: ${vehicle.model || '-'}
สี: ${vehicle.color || '-'}
ปีรถ: ${vehicle.year || '-'}
เลขตัวถัง: ${vehicle.chassisNumber || '-'}
`;
      }

      // Add insurance details from items - กรองเฉพาะประกันภัยและพรบ
      if (items && items.length > 0) {
        // กรองเฉพาะรายการประกันภัยและพรบ
        const insuranceItems = items.filter(item => 
          item.serviceType === 'ประกันภัย' || item.serviceType === 'พรบ'
        );
        
        if (insuranceItems.length > 0) {
          emailContent += `
=== รายละเอียดประกัน ===`;
          
          insuranceItems.forEach((item, index) => {
            const company = companies.find(c => c.id === item.insuranceCompany);
            emailContent += `
            
รายการที่ ${index + 1}:
ประเภทบริการ: ${item.serviceType}
ประเภทประกัน: ${item.insuranceType || '-'}
รายละเอียด: ${item.details || '-'}
ทุนประกัน: ${formatNumber(item.sumInsured)} บาท
เบี้ยประกัน: ${formatNumber(item.premium)} บาท
วันเริ่ม: ${formatDate(item.startDate)}
วันสิ้นสุด: ${formatDate(item.endDate)}
บริษัทประกัน: ${company ? company.name : '-'}
`;
          });
        }
      }

      // Add chassis number to email content if available
      if (chassisNumber) {
        emailContent += `
        
หมายเหตุ: เลขตัวถัง ${chassisNumber}
`;
      }

      // Create modal content with license plate in subject
      const emailSubject = licensePlate ? 
        `แจ้งข้อมูลประกันภัย - ${customer.name} - ทะเบียน ${licensePlate}` : 
        `แจ้งข้อมูลประกันภัย - ${customer.name}`;
      
      const modalContent = `
        <div class="form-group">
          <label>เลือกบริษัทประกันที่จะส่งอีเมล</label>
          <select class="form-control" id="email-company-select">
            <option value="">-- เลือกบริษัทประกัน --</option>
            ${companies.filter(c => c.status === 'Active')
              .map(c => `<option value="${c.id}" data-email="${c.email || ''}">${c.name}</option>`)
              .join('')}
          </select>
        </div>
        
        <div class="form-group">
          <label>อีเมลผู้รับ</label>
          <input type="email" class="form-control" id="email-to" placeholder="example@company.com">
        </div>
        
        <div class="form-group">
          <label>CC (สำเนาถึง)</label>
          <input type="email" class="form-control" id="email-cc" placeholder="employee@company.com">
          <small class="text-muted">อีเมลพนักงานที่ต้องการให้ส่งสำเนาถึง</small>
        </div>
        
        <div class="form-group">
          <label>หัวข้ออีเมล</label>
          <input type="text" class="form-control" id="email-subject" value="${emailSubject}">
        </div>
        
        <div class="form-group">
          <label>คำสั่งเพิ่มเติม</label>
          <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <label class="checkbox-label">
              <input type="checkbox" id="additional-car-check-company" value="ตรวจสภาพรถโดยบริษัท">
              <span>ตรวจสภาพรถโดยบริษัท</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="additional-car-check-agent" value="ตรวจสภาพรถโดยตัวแทน">
              <span>ตรวจสภาพรถโดยตัวแทน</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="additional-prb" value="พรบ.">
              <span>พ.ร.บ.</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label>ข้อความเพิ่มเติม (ถ้ามี)</label>
          <textarea class="form-control" id="email-additional-message" rows="3" placeholder="ข้อความเพิ่มเติม..."></textarea>
        </div>
        
        <div class="form-group">
          <label>เนื้อหาอีเมล</label>
          <textarea class="form-control" id="email-body" rows="15" style="font-family: monospace; font-size: 13px;">${emailContent}</textarea>
        </div>
      `;

      // Use search results modal to display email form
      const modal = document.getElementById('search-results-modal');
      const content = document.getElementById('search-results-content');
      
      if (modal && content) {
        // Update modal header
        const modalHeader = modal.querySelector('.modal-header h3');
        if (modalHeader) {
          modalHeader.textContent = 'ส่งอีเมลแจ้งงาน';
        }
        
        content.innerHTML = modalContent;
        
        // Add footer with buttons
        const modalBody = modal.querySelector('.modal-body');
        if (modalBody) {
          const footer = document.createElement('div');
          footer.className = 'modal-footer';
          footer.style.marginTop = '20px';
          footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal('search-results-modal')">ยกเลิก</button>
            <button class="btn btn-primary" onclick="sendEmailNotification('${workOrder.id}')">
              <span class="material-icons">send</span>
              ส่งอีเมล
            </button>
          `;
          modalBody.appendChild(footer);
        }
        
        modal.style.display = 'block';
        
        // Setup event listeners
        setupEmailModalListeners(workOrder.id);
        
        // Auto-fill employee email to CC field
        const emailCcField = document.getElementById('email-cc');
        if (emailCcField && window.EMPLOYEE_EMAIL) {
          emailCcField.value = window.EMPLOYEE_EMAIL;
        }
      }
    }
    
    function setupEmailModalListeners(workOrderId) {
      // Company select change handler - แก้ไขให้ดึงอีเมลจาก data attribute
      const companySelect = document.getElementById('email-company-select');
      if (companySelect) {
        companySelect.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const email = selectedOption.getAttribute('data-email');
          if (email) {
            document.getElementById('email-to').value = email;
          } else {
            document.getElementById('email-to').value = '';
          }
        });
      }
      
      // Additional services checkboxes - อัพเดตรายการใหม่
      const checkboxes = ['additional-car-check-company', 'additional-car-check-agent', 'additional-prb'];
      checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.addEventListener('change', updateEmailBody);
        }
      });
      
      // Additional message
      const additionalMessage = document.getElementById('email-additional-message');
      if (additionalMessage) {
        additionalMessage.addEventListener('input', updateEmailBody);
      }
    }
    
    function updateEmailBody() {
      const bodyTextarea = document.getElementById('email-body');
      if (!bodyTextarea) return;
      
      let content = bodyTextarea.value;
      
      // Remove existing additional services section
      const additionalStart = content.indexOf('=== คำสั่งเพิ่มเติม ===');
      if (additionalStart !== -1) {
        const nextSection = content.indexOf('===', additionalStart + 20);
        if (nextSection !== -1) {
          content = content.substring(0, additionalStart) + content.substring(nextSection);
        } else {
          content = content.substring(0, additionalStart);
        }
      }
      
      // Remove existing additional message section
      const messageStart = content.indexOf('=== ข้อความเพิ่มเติม ===');
      if (messageStart !== -1) {
        content = content.substring(0, messageStart);
      }
      
      // Add additional services - อัพเดตรายการใหม่
      const checkedServices = [];
      if (document.getElementById('additional-car-check-company')?.checked) checkedServices.push('ตรวจสภาพรถโดยบริษัท');
      if (document.getElementById('additional-car-check-agent')?.checked) checkedServices.push('ตรวจสภาพรถโดยตัวแทน');
      if (document.getElementById('additional-prb')?.checked) checkedServices.push('พ.ร.บ.');
      
      if (checkedServices.length > 0) {
        content += `
=== คำสั่งเพิ่มเติม ===
${checkedServices.join(', ')}
`;
      }
      
      // Add additional message
      const additionalMessage = document.getElementById('email-additional-message')?.value.trim();
      if (additionalMessage) {
        content += `
=== ข้อความเพิ่มเติม ===
${additionalMessage}
`;
      }
      
      bodyTextarea.value = content;
    }
    
    async function sendEmailNotification(workOrderId) {
      const emailTo = document.getElementById('email-to')?.value.trim();
      const emailCc = document.getElementById('email-cc')?.value.trim();
      const emailSubject = document.getElementById('email-subject')?.value.trim();
      const emailBody = document.getElementById('email-body')?.value;
      
      if (!emailTo) {
        showToast('กรุณาใส่อีเมลผู้รับ', 'warning');
        return;
      }
      
      if (!emailSubject) {
        showToast('กรุณาใส่หัวข้ออีเมล', 'warning');
        return;
      }
      
      if (!emailBody) {
        showToast('กรุณาใส่เนื้อหาอีเมล', 'warning');
        return;
      }
      
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailTo)) {
        showToast('รูปแบบอีเมลผู้รับไม่ถูกต้อง', 'warning');
        return;
      }
      
      // Validate CC email if provided
      if (emailCc && !emailRegex.test(emailCc)) {
        showToast('รูปแบบอีเมล CC ไม่ถูกต้อง', 'warning');
        return;
      }
      
      try {
        showLoading('กำลังส่งอีเมล...');
        
        const result = await callGoogleScript('sendEmailNotification', {
          to: emailTo,
          cc: emailCc,
          subject: emailSubject,
          body: emailBody,
          workOrderId: workOrderId
        });
        
        if (result && result.success) {
          showToast('ส่งอีเมลสำเร็จ', 'success');
          closeModal('search-results-modal');
          
          // Update work order status
          await updateWorkOrderStatus(workOrderId, 'แจ้งงานแล้ว');
          await refreshWorkOrderList();
        } else {
          throw new Error(result?.message || 'Send email failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error sending email:', error);
        showToast(`ไม่สามารถส่งอีเมลได้: ${error.message}`, 'error');
      }
    }
    
    async function updateWorkOrderStatus(workOrderId, status) {
      // This is a placeholder - you might want to implement this in Code.gs
      console.log(`Updating work order ${workOrderId} status to ${status}`);
    }
    
    // ==================== PRINT INDIVIDUAL WORK ORDER ====================
    async function printWorkOrder(workOrderId) {
      try {
        showLoading('กำลังเตรียมข้อมูลสำหรับพิมพ์...');
        
        // Get work order details
        let workOrder = workOrders.find(wo => wo.id === workOrderId);
        
        if (!workOrder) {
          const searchResult = await callGoogleScript('searchWorkOrders', workOrderId);
          if (searchResult && searchResult.success && searchResult.data.length > 0) {
            workOrder = searchResult.data.find(wo => wo.id === workOrderId);
          }
        }
        
        if (!workOrder) {
          hideLoading();
          showToast('ไม่พบข้อมูลใบงาน', 'error');
          return;
        }
        
        // Get customer details
        const customer = customers.find(c => c.id === workOrder.customerId);
        if (!customer) {
          hideLoading();
          showToast('ไม่พบข้อมูลลูกค้า', 'error');
          return;
        }
        
        // Get work order items
        const items = await callGoogleScript('getWorkOrderItems', workOrderId);
        
        // Get asset details
        let assetDetails = null;
        let vehicleInfo = null;
        if (workOrder.propertyId) {
          if (workOrder.propertyId.startsWith('VEH')) {
            vehicleInfo = vehicles.find(v => v.id === workOrder.propertyId);
            if (vehicleInfo) {
              assetDetails = {
                type: 'vehicle',
                data: vehicleInfo
              };
            }
          } else {
            const property = properties.find(p => p.id === workOrder.propertyId);
            if (property) {
              assetDetails = {
                type: 'property',
                data: property
              };
            }
          }
        }
        
        // Create print content - ปรับแต่งให้อยู่ในหน้าเดียว
        let printContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>ใบงาน ${workOrderId}</title>
            <style>
              @page { 
                size: A4; 
                margin: 10mm;
              }
              @media print {
                body { 
                  margin: 0; 
                  font-family: 'Sarabun', sans-serif;
                  font-size: 12px;
                }
                .no-print { display: none !important; }
                .page-break { page-break-before: always; }
              }
              body {
                font-family: 'Sarabun', sans-serif;
                font-size: 12px;
                line-height: 1.4;
                color: #333;
              }
              .print-container {
                page-break-inside: avoid;
                width: 100%;
                max-width: 210mm;
                margin: 0 auto;
              }
              .header {
                text-align: center;
                margin-bottom: 15px;
                border-bottom: 2px solid #2c3e50;
                padding-bottom: 10px;
              }
              .header h1 {
                color: #2c3e50;
                margin: 0;
                font-size: 20px;
              }
              .header p {
                margin: 3px 0;
                color: #666;
                font-size: 11px;
              }
              .section {
                margin-bottom: 10px;
                background: #f9f9f9;
                padding: 8px;
                border-radius: 3px;
              }
              .section h3 {
                color: #2c3e50;
                margin-top: 0;
                margin-bottom: 5px;
                font-size: 14px;
                border-bottom: 1px solid #ddd;
                padding-bottom: 3px;
              }
              .info-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
              }
              .info-item {
                margin-bottom: 3px;
              }
              .info-item label {
                font-weight: bold;
                color: #555;
                display: inline-block;
                min-width: 100px;
                font-size: 11px;
              }
              .info-item span {
                color: #333;
                font-size: 11px;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 5px;
                font-size: 10px;
              }
              th, td {
                border: 1px solid #ddd;
                padding: 4px;
                text-align: left;
              }
              th {
                background-color: #2c3e50;
                color: white;
                font-weight: bold;
                font-size: 10px;
              }
              tr:nth-child(even) {
                background-color: #f9f9f9;
              }
              .text-right {
                text-align: right;
              }
              .text-center {
                text-align: center;
              }
              .total-section {
                margin-top: 10px;
                padding: 10px;
                background: #e8f4f8;
                border-radius: 3px;
                border: 1px solid #3498db;
              }
              .total-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                text-align: center;
              }
              .total-item h4 {
                margin: 0;
                color: #2c3e50;
                font-size: 16px;
              }
              .total-item p {
                margin: 2px 0;
                color: #666;
                font-size: 10px;
              }
              .footer {
                margin-top: 15px;
                padding-top: 10px;
                border-top: 1px solid #ddd;
                text-align: center;
                color: #666;
                font-size: 10px;
              }
              .company-header {
                margin-bottom: 10px;
                text-align: center;
              }
              .company-header h2 {
                color: #2c3e50;
                margin: 0;
                font-size: 16px;
              }
              .company-header p {
                margin: 2px 0;
                color: #666;
                font-size: 10px;
              }
            </style>
          </head>
          <body>
            <div class="print-container">
              <div class="company-header">
                <h2>Insurance Sale Management</h2>
                <p>ระบบจัดการขายประกันภัย</p>
              </div>
              
              <div class="header">
                <h1>ใบงาน</h1>
                <p>เลขที่: ${workOrderId} | วันที่สร้าง: ${formatDate(workOrder.createdDate)} | สถานะ: ${workOrder.status}</p>
              </div>
              
              <div class="section">
                <h3>ข้อมูลลูกค้า</h3>
                <div class="info-grid">
                  <div class="info-item">
                    <label>ชื่อ-นามสกุล:</label>
                    <span>${customer.name}</span>
                  </div>
                  <div class="info-item">
                    <label>เลขบัตรประชาชน:</label>
                    <span>${customer.idCard || '-'}</span>
                  </div>
                  <div class="info-item">
                    <label>เบอร์โทร:</label>
                    <span>${customer.phone || '-'}</span>
                  </div>
                  <div class="info-item">
                    <label>อีเมล:</label>
                    <span>${customer.email || '-'}</span>
                  </div>
                </div>
                <div class="info-item">
                  <label>ที่อยู่ตามเอกสาร:</label>
                  <span>${customer.documentAddress || '-'}</span>
                </div>
              </div>
        `;
        
        // Add vehicle info if available
        if (vehicleInfo) {
          printContent += `
            <div class="section">
              <h3>ข้อมูลรถ</h3>
              <div class="info-grid">
                <div class="info-item">
                  <label>ทะเบียนรถ:</label>
                  <span>${vehicleInfo.licensePlate}</span>
                </div>
                <div class="info-item">
                  <label>ยี่ห้อ/รุ่น:</label>
                  <span>${vehicleInfo.brand || '-'} ${vehicleInfo.model || ''}</span>
                </div>
                <div class="info-item">
                  <label>สี:</label>
                  <span>${vehicleInfo.color || '-'}</span>
                </div>
                <div class="info-item">
                  <label>ปีรถ:</label>
                  <span>${vehicleInfo.year || '-'}</span>
                </div>
                <div class="info-item">
                  <label>เลขตัวถัง:</label>
                  <span>${vehicleInfo.chassisNumber || '-'}</span>
                </div>
              </div>
            </div>
          `;
        }
        
        // Add work order items - ปรับขนาดตารางให้เล็กลง
        printContent += `
          <div class="section">
            <h3>รายการในใบงาน</h3>
            <table>
              <thead>
                <tr>
                  <th style="width: 3%;">ลำดับ</th>
                  <th style="width: 12%;">ประเภทบริการ</th>
                  <th style="width: 18%;">รายละเอียด</th>
                  <th style="width: 10%;">ประเภทประกัน</th>
                  <th style="width: 10%;" class="text-right">ทุนประกัน</th>
                  <th style="width: 10%;" class="text-right">เบี้ยประกัน</th>
                  <th style="width: 9%;" class="text-center">วันเริ่ม</th>
                  <th style="width: 9%;" class="text-center">วันสิ้นสุด</th>
                  <th style="width: 10%;">เลขกรมธรรม์</th>
                  <th style="width: 9%;">บริษัทประกัน</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        let totalPremium = 0;
        let totalSumInsured = 0;
        
        items.forEach((item, index) => {
          totalPremium += parseFloat(item.premium) || 0;
          totalSumInsured += parseFloat(item.sumInsured) || 0;
          
          const company = companies.find(c => c.id === item.insuranceCompany);
          const companyName = company ? company.name.replace(/บริษัท|จำกัด|\(มหาชน\)/g, '').trim() : '-';
          
          printContent += `
            <tr>
              <td class="text-center">${index + 1}</td>
              <td>${item.serviceType || '-'}</td>
              <td style="font-size: 9px;">${item.details || '-'}</td>
              <td>${item.insuranceType || '-'}</td>
              <td class="text-right">฿${formatNumber(item.sumInsured)}</td>
              <td class="text-right">฿${formatNumber(item.premium)}</td>
              <td class="text-center" style="font-size: 9px;">${item.startDate ? formatDate(item.startDate) : '-'}</td>
              <td class="text-center" style="font-size: 9px;">${item.endDate ? formatDate(item.endDate) : '-'}</td>
              <td style="font-size: 9px;">${item.policyNumber || '-'}</td>
              <td style="font-size: 9px;">${companyName}</td>
            </tr>
          `;
        });
        
        printContent += `
              </tbody>
            </table>
          </div>
          
          <div class="total-section">
            <h3 style="text-align: center; margin-top: 0; font-size: 14px;">สรุปยอดรวม</h3>
            <div class="total-grid">
              <div class="total-item">
                <h4>${items.length}</h4>
                <p>จำนวนรายการ</p>
              </div>
              <div class="total-item">
                <h4>฿${formatNumber(totalSumInsured)}</h4>
                <p>ทุนประกันรวม</p>
              </div>
              <div class="total-item">
                <h4>฿${formatNumber(totalPremium)}</h4>
                <p>เบี้ยประกันรวม</p>
              </div>
            </div>
          </div>
          
          <div class="footer">
            <p>พิมพ์วันที่: ${formatDateTime(new Date())} | พิมพ์โดย: ${currentUser || 'ผู้ใช้งาน'}</p>
            <p>Insurance Sale Management System</p>
          </div>
        </div>
        </body>
        </html>
        `;
        
        hideLoading();
        
        // Open print window
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        
        // Wait for content to load then print
        printWindow.onload = function() {
          printWindow.print();
        };
        
      } catch (error) {
        hideLoading();
        console.error('Error printing work order:', error);
        showToast('ไม่สามารถพิมพ์ใบงานได้', 'error');
      }
    }
    
    // ==================== PRINT WORK ORDER SUMMARY ====================
    async function printWorkOrderSummary() {
      try {
        showLoading('กำลังเตรียมข้อมูลสำหรับพิมพ์...');
        
        // Get all work orders
        const allWorkOrders = await callGoogleScript('getWorkOrderList');
        
        if (!allWorkOrders || allWorkOrders.length === 0) {
          hideLoading();
          showToast('ไม่มีข้อมูลใบงานสำหรับพิมพ์', 'warning');
          return;
        }
        
        // Sort by date (newest first)
        const sortedWorkOrders = allWorkOrders.sort((a, b) => {
          const dateA = new Date(a.createdDate || 0);
          const dateB = new Date(b.createdDate || 0);
          return dateB - dateA;
        });
        
        // Create print content
        let printContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>สรุปรายการใบงาน</title>
            <style>
              @page { size: A4; margin: 15mm; }
              @media print {
                body { margin: 0; font-family: 'Sarabun', sans-serif; }
                .no-print { display: none !important; }
              }
              body {
                font-family: 'Sarabun', sans-serif;
                font-size: 14px;
                line-height: 1.6;
                color: #333;
              }
              h1 {
                text-align: center;
                color: #2c3e50;
                margin-bottom: 20px;
              }
              .header-info {
                text-align: center;
                margin-bottom: 30px;
                color: #666;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
              }
              th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
              }
              th {
                background-color: #2c3e50;
                color: white;
                font-weight: bold;
              }
              tr:nth-child(even) {
                background-color: #f9f9f9;
              }
              .text-right {
                text-align: right;
              }
              .text-center {
                text-align: center;
              }
              .summary {
                margin-top: 30px;
                padding: 20px;
                background-color: #f5f5f5;
                border-radius: 5px;
              }
              .summary h3 {
                margin-top: 0;
                color: #2c3e50;
              }
              .summary-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
              }
              .summary-item {
                text-align: center;
              }
              .summary-item h4 {
                margin: 0;
                color: #3498db;
                font-size: 24px;
              }
              .summary-item p {
                margin: 5px 0;
                color: #666;
              }
              .footer {
                margin-top: 40px;
                text-align: center;
                color: #666;
                font-size: 12px;
              }
              @media print {
                .summary { break-inside: avoid; }
              }
            </style>
          </head>
          <body>
            <h1>สรุปรายการใบงาน</h1>
            <div class="header-info">
              <p>วันที่พิมพ์: ${formatDateTime(new Date())}</p>
              <p>จำนวนใบงานทั้งหมด: ${sortedWorkOrders.length} รายการ</p>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th style="width: 5%;">ลำดับ</th>
                  <th style="width: 15%;">เลขที่ใบงาน</th>
                  <th style="width: 12%;">วันที่สร้าง</th>
                  <th style="width: 20%;">ชื่อลูกค้า</th>
                  <th style="width: 10%;">ทะเบียนรถ</th>
                  <th style="width: 10%;">ประเภท</th>
                  <th style="width: 10%;" class="text-right">เบี้ยประกัน</th>
                  <th style="width: 10%;" class="text-center">สถานะ</th>
                  <th style="width: 8%;">ผู้สร้าง</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        let totalPremium = 0;
        let statusCount = {};
        
        sortedWorkOrders.forEach((wo, index) => {
          // Find vehicle info
          let licensePlate = '-';
          if (wo.propertyId && wo.propertyId.startsWith('VEH')) {
            const vehicle = vehicles.find(v => v.id === wo.propertyId);
            if (vehicle) licensePlate = vehicle.licensePlate;
          }
          
          totalPremium += wo.premium || 0;
          statusCount[wo.status] = (statusCount[wo.status] || 0) + 1;
          
          printContent += `
            <tr>
              <td class="text-center">${index + 1}</td>
              <td>${wo.id}</td>
              <td>${formatDate(wo.createdDate)}</td>
              <td>${wo.customerName}</td>
              <td>${licensePlate}</td>
              <td>${wo.insuranceType || '-'}</td>
              <td class="text-right">฿${formatNumber(wo.premium)}</td>
              <td class="text-center">${wo.status}</td>
              <td>${wo.createdBy || '-'}</td>
            </tr>
          `;
        });
        
        printContent += `
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="6" class="text-right">รวมเบี้ยประกันทั้งหมด:</th>
                  <th class="text-right">฿${formatNumber(totalPremium)}</th>
                  <th colspan="2"></th>
                </tr>
              </tfoot>
            </table>
            
            <div class="summary">
              <h3>สรุปข้อมูล</h3>
              <div class="summary-grid">
                <div class="summary-item">
                  <h4>${sortedWorkOrders.length}</h4>
                  <p>ใบงานทั้งหมด</p>
                </div>
                <div class="summary-item">
                  <h4>฿${formatNumber(totalPremium)}</h4>
                  <p>มูลค่ารวม</p>
                </div>
                <div class="summary-item">
                  <h4>${statusCount['แจ้งงานแล้ว'] || 0}</h4>
                  <p>แจ้งงานแล้ว</p>
                </div>
              </div>
            </div>
            
            <div class="footer">
              <p>Insurance Sale Management System</p>
              <p>พิมพ์โดย: ${currentUser || 'ผู้ใช้งาน'}</p>
            </div>
          </body>
          </html>
        `;
        
        hideLoading();
        
        // Open print window
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        
        // Wait for content to load then print
        printWindow.onload = function() {
          printWindow.print();
        };
        
      } catch (error) {
        hideLoading();
        console.error('Error printing work order summary:', error);
        showToast('ไม่สามารถพิมพ์สรุปรายการได้', 'error');
      }
    }
    
    // ==================== SEARCH VEHICLES FUNCTION ====================
    async function searchVehicles(searchText) {
      if (!searchText || searchText.trim() === '') {
        return { success: true, data: [] };
      }
      
      const searchLower = searchText.toLowerCase();
      const results = vehicles.filter(vehicle => {
        const licensePlate = (vehicle.licensePlate || '').toLowerCase();
        return licensePlate.includes(searchLower);
      });
      
      return { success: true, data: results };
    }
    
    // ==================== PAYMENT FUNCTIONS ====================
    function handlePaymentTypeChange() {
      const paymentType = document.getElementById('wo-payment-type');
      const installmentGroup = document.getElementById('installment-group');
      const bankGroup = document.getElementById('bank-group');
      const referenceGroup = document.getElementById('payment-reference-group');
      const installmentPlan = document.getElementById('installment-plan');
      
      if (!paymentType) return;
      
      // Reset all groups
      if (installmentGroup) installmentGroup.style.display = 'none';
      if (bankGroup) bankGroup.style.display = 'none';
      if (installmentPlan) installmentPlan.style.display = 'none';
      
      // Show/hide based on payment type
      switch(paymentType.value) {
        case 'ผ่อนชำระ':
          if (installmentGroup) installmentGroup.style.display = 'block';
          break;
        case 'โอนเงิน':
          if (bankGroup) bankGroup.style.display = 'block';
          if (referenceGroup) {
            const label = referenceGroup.querySelector('label');
            if (label) label.textContent = 'เลขที่อ้างอิงการโอน';
          }
          break;
        case 'บัตรเครดิต':
          if (referenceGroup) {
            const label = referenceGroup.querySelector('label');
            if (label) label.textContent = '4 หลักท้ายบัตร';
          }
          break;
        case 'เงินสด':
          if (referenceGroup) {
            const label = referenceGroup.querySelector('label');
            if (label) label.textContent = 'ใบเสร็จเลขที่';
          }
          break;
      }
    }
    
    function generateInstallmentPlan() {
      const installments = document.getElementById('wo-installments');
      const installmentPlan = document.getElementById('installment-plan');
      const installmentBody = document.getElementById('installment-plan-body');
      
      if (!installments || !installmentPlan || !installmentBody) return;
      
      const numberOfInstallments = parseInt(installments.value);
      if (!numberOfInstallments) {
        installmentPlan.style.display = 'none';
        return;
      }
      
      // Calculate total premium
      const totalPremium = workOrderItems.reduce((sum, item) => sum + (parseFloat(item.premium) || 0), 0);
      const amountPerInstallment = Math.ceil(totalPremium / numberOfInstallments);
      
      // Get start date
      const paymentDate = document.getElementById('wo-payment-date');
      const startDate = paymentDate && paymentDate.value ? new Date(paymentDate.value) : new Date();
      
      // Build or reset global plan array
      installmentPlanData = [];
      
      // Generate installment rows
      let installmentHtml = '';
      for (let i = 0; i < numberOfInstallments; i++) {
        const dueDate = new Date(startDate);
        dueDate.setMonth(dueDate.getMonth() + i);
        const isoDate = dueDate.toISOString().split('T')[0];
        const amount = (i === 0) ? amountPerInstallment : amountPerInstallment;
        installmentPlanData.push({
          installmentNumber: i + 1,
          totalInstallments: numberOfInstallments,
          amount: amount,
          dueDate: isoDate,
          status: 'รอชำระ'
        });
        installmentHtml += `
          <tr>
            <td>งวดที่ ${i + 1}</td>
            <td>${i === 0 ? `<input type="number" class="form-control" value="${amount}" min="0" step="0.01" onchange="updateFirstInstallmentAmount(this.value)">` : `฿${formatNumber(amount)}`}</td>
            <td><input type="date" class="form-control" value="${isoDate}" onchange="updateInstallmentDueDate(${i}, this.value)"></td>
            <td><span class="badge badge-warning">รอชำระ</span></td>
            <td><button class="btn btn-success btn-sm" onclick="markInstallmentPaid(${i + 1})"><span class="material-icons">check_circle</span></button></td>
          </tr>
        `;
      }
      
      installmentBody.innerHTML = installmentHtml;
      installmentPlan.style.display = 'block';
    }
    
    function updateFirstInstallmentAmount(newAmount) {
      const amount0 = parseFloat(newAmount) || 0;
      if (!installmentPlanData.length) return;
      const totalPremium = workOrderItems.reduce((sum, item) => sum + (parseFloat(item.premium) || 0), 0);
      const remaining = Math.max(totalPremium - amount0, 0);
      const otherCount = installmentPlanData.length - 1;
      const per = otherCount > 0 ? Math.ceil(remaining / otherCount) : 0;
      installmentPlanData[0].amount = amount0;
      for (let i = 1; i < installmentPlanData.length; i++) {
        installmentPlanData[i].amount = per;
      }
      renderInstallmentPlan();
    }
    
    function updateInstallmentDueDate(index, dateStr) {
      if (!installmentPlanData[index]) return;
      installmentPlanData[index].dueDate = dateStr;
    }
    
    function renderInstallmentPlan() {
      const installmentBody = document.getElementById('installment-plan-body');
      if (!installmentBody) return;
      let html = '';
      installmentPlanData.forEach((inst, idx) => {
        html += `
          <tr>
            <td>งวดที่ ${inst.installmentNumber}</td>
            <td>${idx === 0 ? `<input type="number" class="form-control" value="${inst.amount}" min="0" step="0.01" onchange="updateFirstInstallmentAmount(this.value)">` : `฿${formatNumber(inst.amount)}`}</td>
            <td><input type="date" class="form-control" value="${inst.dueDate}" onchange="updateInstallmentDueDate(${idx}, this.value)"></td>
            <td><span class="badge ${inst.status === 'ชำระแล้ว' ? 'badge-success' : 'badge-warning'}">${inst.status}</span></td>
            <td><button class="btn btn-success btn-sm" onclick="markInstallmentPaid(${inst.installmentNumber})"><span class="material-icons">check_circle</span></button></td>
          </tr>`;
      });
      installmentBody.innerHTML = html;
    }
    
    function openPaymentModal(workOrderId) {
      // Get work order details
      const workOrder = workOrders.find(wo => wo.id === workOrderId);
      if (!workOrder) {
        showToast('ไม่พบข้อมูลใบงาน', 'error');
        return;
      }
      
      // Create payment modal content
      const modalContent = `
        <div class="form-group">
          <label>เลขที่ใบงาน</label>
          <input type="text" class="form-control" value="${workOrderId}" readonly>
        </div>
        <div class="form-group">
          <label>ลูกค้า</label>
          <input type="text" class="form-control" value="${workOrder.customerName}" readonly>
        </div>
        <div class="form-group">
          <label>ยอดค้างชำระ</label>
          <input type="text" class="form-control" value="฿${formatNumber(workOrder.remainingAmount || workOrder.premium)}" readonly>
        </div>
        <div class="form-group">
          <label>จำนวนเงินที่ชำระ *</label>
          <input type="number" class="form-control" id="payment-amount" min="0" step="0.01" required>
        </div>
        <div class="form-group">
          <label>ประเภทการชำระเงิน *</label>
          <select class="form-control" id="payment-type" required onchange="handleModalPaymentTypeChange()">
            <option value="">-- เลือกประเภท --</option>
            <option value="โอนเงิน">โอนเงิน</option>
            <option value="บัตรเครดิต">บัตรเครดิต</option>
            <option value="เงินสด">เงินสด</option>
          </select>
        </div>
        <div class="form-group" id="modal-bank-group" style="display: none;">
          <label>ธนาคาร</label>
          <select class="form-control" id="payment-bank">
            <option value="">-- เลือกธนาคาร --</option>
            <option value="กรุงเทพ">ธนาคารกรุงเทพ</option>
            <option value="กสิกรไทย">ธนาคารกสิกรไทย</option>
            <option value="ไทยพาณิชย์">ธนาคารไทยพาณิชย์</option>
            <option value="กรุงไทย">ธนาคารกรุงไทย</option>
            <option value="ทหารไทยธนชาต">ธนาคารทหารไทยธนชาต</option>
            <option value="กรุงศรี">ธนาคารกรุงศรี</option>
            <option value="ออมสิน">ธนาคารออมสิน</option>
            <option value="อื่นๆ">อื่นๆ</option>
          </select>
        </div>
        <div class="form-group">
          <label id="payment-reference-label">เลขที่อ้างอิง</label>
          <input type="text" class="form-control" id="payment-reference">
        </div>
        <div class="form-group">
          <label>หมายเหตุ</label>
          <textarea class="form-control" id="payment-notes" rows="2"></textarea>
        </div>
      `;
      
      // Use search results modal to display payment form
      const modal = document.getElementById('search-results-modal');
      const content = document.getElementById('search-results-content');
      
      if (modal && content) {
        // Update modal header
        const modalHeader = modal.querySelector('.modal-header h3');
        if (modalHeader) {
          modalHeader.textContent = 'บันทึกการชำระเงิน';
        }
        
        content.innerHTML = modalContent;
        
        // Add footer with buttons
        const modalBody = modal.querySelector('.modal-body');
        if (modalBody) {
          const footer = document.createElement('div');
          footer.className = 'modal-footer';
          footer.style.marginTop = '20px';
          footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal('search-results-modal')">ยกเลิก</button>
            <button class="btn btn-primary" onclick="savePayment('${workOrderId}')">
              <span class="material-icons">save</span>
              บันทึกการชำระ
            </button>
          `;
          modalBody.appendChild(footer);
        }
        
        modal.style.display = 'block';
      }
    }
    
    function handleModalPaymentTypeChange() {
      const paymentType = document.getElementById('payment-type');
      const bankGroup = document.getElementById('modal-bank-group');
      const referenceLabel = document.getElementById('payment-reference-label');
      
      if (!paymentType) return;
      
      // Reset
      if (bankGroup) bankGroup.style.display = 'none';
      
      // Show/hide based on payment type
      switch(paymentType.value) {
        case 'โอนเงิน':
          if (bankGroup) bankGroup.style.display = 'block';
          if (referenceLabel) referenceLabel.textContent = 'เลขที่อ้างอิงการโอน';
          break;
        case 'บัตรเครดิต':
          if (referenceLabel) referenceLabel.textContent = '4 หลักท้ายบัตร';
          break;
        case 'เงินสด':
          if (referenceLabel) referenceLabel.textContent = 'ใบเสร็จเลขที่';
          break;
      }
    }
    
    async function savePayment(workOrderId) {
      const amount = document.getElementById('payment-amount')?.value;
      const paymentType = document.getElementById('payment-type')?.value;
      
      if (!amount || parseFloat(amount) <= 0) {
        showToast('กรุณาใส่จำนวนเงินที่ชำระ', 'warning');
        return;
      }
      
      if (!paymentType) {
        showToast('กรุณาเลือกประเภทการชำระเงิน', 'warning');
        return;
      }
      
      const paymentData = {
        workOrderId: workOrderId,
        amount: parseFloat(amount),
        paymentType: paymentType,
        referenceNumber: document.getElementById('payment-reference')?.value || '',
        bank: document.getElementById('payment-bank')?.value || '',
        notes: document.getElementById('payment-notes')?.value || ''
      };
      
      try {
        showLoading('กำลังบันทึกการชำระเงิน...');
        
        const result = await callGoogleScript('savePayment', paymentData);
        
        if (result && result.success) {
          showToast(result.message, 'success');
          closeModal('search-results-modal');
          await refreshWorkOrderList();
        } else {
          throw new Error(result?.message || 'Save payment failed');
        }
        
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error saving payment:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }
    
    async function viewPaymentHistory(workOrderId) {
      try {
        showLoading('กำลังโหลดประวัติการชำระเงิน...');
        
        const payments = await callGoogleScript('getPaymentHistory', workOrderId);
        const installments = await callGoogleScript('getInstallmentPlan', workOrderId);
        
        hideLoading();
        displayPaymentHistory(workOrderId, payments, installments);
      } catch (error) {
        hideLoading();
        console.error('Error loading payment history:', error);
        showToast('ไม่สามารถโหลดประวัติการชำระเงินได้', 'error');
      }
    }
    
    function displayPaymentHistory(workOrderId, payments, installments) {
      let historyHtml = `
        <h4>ประวัติการชำระเงิน - ใบงาน ${workOrderId}</h4>
      `;
      
      // Payment history table
      if (payments && payments.length > 0) {
        historyHtml += `
          <h5>รายการชำระเงิน</h5>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>วันที่ชำระ</th>
                  <th>ประเภท</th>
                  <th>จำนวนเงิน</th>
                  <th>เลขที่อ้างอิง</th>
                  <th>ธนาคาร</th>
                  <th>หมายเหตุ</th>
                  <th>ผู้บันทึก</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        payments.forEach(payment => {
          historyHtml += `
            <tr>
              <td>${formatDate(payment.paymentDate)}</td>
              <td>${payment.paymentType}</td>
              <td>฿${formatNumber(payment.amount)}</td>
              <td>${payment.referenceNumber || '-'}</td>
              <td>${payment.bank || '-'}</td>
              <td>${payment.notes || '-'}</td>
              <td>${payment.recordedBy || '-'}</td>
            </tr>
          `;
        });
        
        historyHtml += `
              </tbody>
            </table>
          </div>
        `;
      }
      
      // Installment plan if exists
      if (installments && installments.length > 0) {
        historyHtml += `
          <h5 class="mt-3">แผนการผ่อนชำระ</h5>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>งวดที่</th>
                  <th>จำนวนเงิน</th>
                  <th>วันครบกำหนด</th>
                  <th>วันที่ชำระ</th>
                  <th>สถานะ</th>
                  <th>เลขที่อ้างอิง</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        installments.forEach(inst => {
          const statusClass = inst.status === 'ชำระแล้ว' ? 'badge-success' : 'badge-warning';
          historyHtml += `
            <tr>
              <td>${inst.installmentNumber}/${inst.totalInstallments}</td>
              <td>฿${formatNumber(inst.amount)}</td>
              <td>${formatDate(inst.dueDate)}</td>
              <td>${inst.paymentDate ? formatDate(inst.paymentDate) : '-'}</td>
              <td><span class="badge ${statusClass}">${inst.status}</span></td>
              <td>${inst.referenceNumber || '-'}</td>
            </tr>
          `;
        });
        
        historyHtml += `
              </tbody>
            </table>
          </div>
        `;
      }
      
      // Use search results modal to display
      const modal = document.getElementById('search-results-modal');
      const content = document.getElementById('search-results-content');
      
      if (modal && content) {
        content.innerHTML = historyHtml;
        modal.style.display = 'block';
      }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    function formatNumber(num) {
      const number = parseFloat(num) || 0;
      return number.toLocaleString('th-TH', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
      });
    }
    
    function formatDate(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        const months = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
        return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
      } catch (error) {
        return '-';
      }
    }
    
    function formatDateTime(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        return `${formatDate(dateString)} ${date.toLocaleTimeString('th-TH')}`;
      } catch (error) {
        return '-';
      }
    }
    
    function getStatusBadgeClass(status) {
      const classes = {
        'แจ้งงานแล้ว': 'badge-primary',
        'ได้รับกรมแล้ว': 'badge-success',
        'จัดส่งแล้ว': 'badge-info',
        'ยกเลิก': 'badge-danger',
        'รอต่อภาษี': 'badge-warning'
      };
      return classes[status] || 'badge-secondary';
    }
    
    function getPaymentStatusBadgeClass(status) {
      const classes = {
        'รอชำระเงิน': 'badge-warning',
        'ชำระบางส่วน': 'badge-info',
        'ชำระเต็มจำนวน': 'badge-success',
        'เกินกำหนดชำระ': 'badge-danger',
        'ยกเลิก': 'badge-secondary'
      };
      return classes[status] || 'badge-secondary';
    }
    
    function getServiceTypeColorClass(sheetName) {
      const colors = {
        'ประกันภัย': 'blue',
        'ภาษี': 'orange',
        'ค่าบริการ': 'green',
        'อื่นๆ': 'red'
      };
      return colors[sheetName] || 'blue';
    }
    
    function getServiceTypeIcon(sheetName) {
      const icons = {
        'ประกันภัย': 'security',
        'ภาษี': 'receipt',
        'ค่าบริการ': 'build',
        'อื่นๆ': 'more_horiz'
      };
      return icons[sheetName] || 'description';
    }
    
    // ==================== FORM HANDLERS ====================
    function setupFormHandlers() {
      // Customer form
      const customerForm = document.getElementById('customer-form');
      if (customerForm) {
        customerForm.addEventListener('submit', function(e) {
          e.preventDefault();
          saveCustomer();
        });
      }
      
      // Vehicle form
      const vehicleForm = document.getElementById('vehicle-form');
      if (vehicleForm) {
        vehicleForm.addEventListener('submit', function(e) {
          e.preventDefault();
          saveVehicle();
        });
      }
      
      // Property form
      const propertyForm = document.getElementById('property-form');
      if (propertyForm) {
        propertyForm.addEventListener('submit', function(e) {
          e.preventDefault();
          saveProperty();
        });
      }
    }
    
    // ==================== WINDOW CLICK HANDLER ====================
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
    
    // ==================== MAKE FUNCTIONS GLOBALLY ACCESSIBLE ====================
    window.showPage = showPage;
    window.showSubPage = showSubPage;
    window.closeModal = closeModal;
    window.toggleTheme = toggleTheme;
    window.openCustomerModal = openCustomerModal;
    window.openVehicleModal = openVehicleModal;
    window.openPropertyModal = openPropertyModal;
    window.saveCustomer = saveCustomer;
    window.saveVehicle = saveVehicle;
    window.saveProperty = saveProperty;
    window.editCustomer = editCustomer;
    window.editVehicle = editVehicle;
    window.editProperty = editProperty;
    window.deleteCustomer = deleteCustomer;
    window.deleteVehicle = deleteVehicle;
    window.deleteProperty = deleteProperty;
    window.confirmDelete = confirmDelete;
    window.refreshCustomerList = refreshCustomerList;
    window.refreshVehicleList = refreshVehicleList;
    window.refreshPropertyList = refreshPropertyList;
    window.loadServiceTypeStats = loadServiceTypeStats;
    window.createBackup = createBackup;
    window.testSystemConnection = testSystemConnection;
    window.initializeSystemManually = initializeSystemManually;
    window.loadHistory = loadHistory;
    window.saveSettings = saveSettings;
    window.resetWorkOrderForm = resetWorkOrderForm;
    window.addWorkOrderItem = addWorkOrderItem;
    window.removeWorkOrderItem = removeWorkOrderItem;
    window.updateItemField = updateItemField;
    window.searchWorkOrders = searchWorkOrders;
    window.clearWorkOrderSearch = clearWorkOrderSearch;
    window.refreshWorkOrderList = refreshWorkOrderList;
    window.viewWorkOrderDetails = viewWorkOrderDetails;
    window.editWorkOrder = editWorkOrder;
    window.cloneWorkOrder = cloneWorkOrder;
    window.confirmCancel = confirmCancel;
    window.cancelWorkOrder = cancelWorkOrder;
    window.selectCustomer = selectCustomer;
    window.selectOwnerFromModal = selectOwnerFromModal;
    window.loadAssets = loadAssets;
    window.prepareEmailNotification = prepareEmailNotification;
    window.sendEmailNotification = sendEmailNotification;
    window.updateEmailBody = updateEmailBody;
    window.printWorkOrderSummary = printWorkOrderSummary;
    window.printWorkOrder = printWorkOrder;
    window.searchVehicles = searchVehicles;
    
    window.openPaymentModal = openPaymentModal;
    window.savePayment = savePayment;
    window.handleModalPaymentTypeChange = handleModalPaymentTypeChange;
    window.viewPaymentHistory = viewPaymentHistory;
    window.handlePaymentTypeChange = handlePaymentTypeChange;
    window.generateInstallmentPlan = generateInstallmentPlan;
    window.updateFirstInstallmentAmount = updateFirstInstallmentAmount;
    window.updateInstallmentDueDate = updateInstallmentDueDate;
    window.renderInstallmentPlan = renderInstallmentPlan;
    window.loadInstallmentTracking = loadInstallmentTracking;
    window.loadRenewalTracking = loadRenewalTracking;
    window.markInstallmentPaid = markInstallmentPaid;
    
    console.log('All functions registered globally');
  </script>
</body>
</html>
